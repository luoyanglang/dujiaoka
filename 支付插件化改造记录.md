# 支付插件化改造工作记录

**日期**：2025-12-09  
**目标**：将独角卡数的所有支付功能改造为插件，实现按需安装

---

## ✅ 已完成工作

### 第一阶段：移除原有支付功能

#### 1. 备份代码
- ✅ 创建 Git 备份分支：`backup-before-plugin-market`
- ✅ 创建私有仓库用于开发过程备份
- ✅ 支付控制器备份到：`backup/payment-controllers/`

#### 2. 删除支付控制器（12个）
```
✅ AlipayController.php      - 支付宝
✅ WepayController.php        - 微信支付
✅ TokenPayController.php     - TokenPay
✅ EpusdtController.php       - EPUSDT
✅ PaypalPayController.php    - PayPal
✅ StripeController.php       - Stripe
✅ CoinbaseController.php     - Coinbase
✅ YipayController.php        - 易支付
✅ PayjsController.php        - Payjs
✅ MapayController.php        - 码支付
✅ VpayController.php         - V免签
✅ PaysapiController.php      - Paysapi
```

#### 3. 修改路由配置
**文件**：`routes/common/pay.php`

**修改内容**：
```php
// 原代码：硬编码所有支付路由
Route::get('alipay/{payway}/{orderSN}', 'AlipayController@gateway');
Route::get('wepay/{payway}/{orderSN}', 'WepayController@gateway');
// ... 12个支付方式

// 新代码：动态加载插件路由
Route::group(['middleware' => ['dujiaoka.pay_gate_way']], function () {
    $installedPlugins = \App\Models\InstalledPlugin::where('status', 'active')->get();
    
    foreach ($installedPlugins as $plugin) {
        $routeFile = public_path("plugins/{$plugin->plugin_slug}/routes.php");
        if (file_exists($routeFile)) {
            require $routeFile;
        }
    }
});
```

#### 4. 清空数据库
```sql
-- 清空支付方式数据
TRUNCATE TABLE pays;

-- 删除"支付配置"菜单（ID: 21）
DELETE FROM admin_menu WHERE id = 21;
```

#### 5. 注释后台路由
**文件**：`app/Admin/routes.php`

```php
// 原代码
$router->resource('pay', 'PayController');

// 新代码
// $router->resource('pay', 'PayController'); // 已移除，改为通过支付插件提供
```

### 第二阶段：测试验证

#### 测试结果
- ✅ 网站正常访问
- ✅ 后台正常登录
- ✅ 插件管理页面正常
- ✅ "支付配置"菜单已消失
- ✅ 前台商品页面支付方式不显示（正常，因为没有安装支付插件）
- ✅ 独角卡数变成"纯净版"

---

## 📋 下一步工作：支付插件自动配置机制

### 目标
当用户安装第一个支付插件时：
1. 自动创建"支付配置"菜单
2. 自动添加支付方式到 pays 表
3. 自动显示插件配置页面

### 实现方案

#### 1. 支付插件的 install.php 模板

```php
<?php
/**
 * 支付插件安装脚本模板
 * 
 * 功能：
 * 1. 插入支付方式到 pays 表
 * 2. 检查并创建"支付配置"菜单
 * 3. 注册后台路由
 */

return function() {
    try {
        // ========== 第一步：插入支付方式 ==========
        $payCheck = 'alipay'; // 支付标识（每个插件不同）
        
        // 检查是否已存在
        $exists = DB::table('pays')->where('pay_check', $payCheck)->exists();
        
        if (!$exists) {
            DB::table('pays')->insert([
                'pay_name' => '支付宝',
                'pay_check' => $payCheck,
                'pay_method' => 2, // 1=跳转, 2=扫码
                'pay_handleroute' => 'pay/alipay',
                'merchant_id' => '',      // 应用ID（用户后台配置）
                'merchant_key' => '',     // 应用私钥（用户后台配置）
                'merchant_pem' => '',     // 支付宝公钥（用户后台配置）
                'is_open' => 0,           // 默认关闭，需要用户配置后开启
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }
        
        // ========== 第二步：检查并创建"支付配置"菜单 ==========
        $payMenu = DB::table('admin_menu')
            ->where('uri', 'pay')
            ->first();
        
        // 如果不存在，创建菜单
        if (!$payMenu) {
            // 找到"配置"父菜单的ID
            $configMenu = DB::table('admin_menu')
                ->where('title', 'Configuration')
                ->first();
            
            $parentId = $configMenu ? $configMenu->id : 19; // 默认19是"配置"菜单
            
            DB::table('admin_menu')->insert([
                'parent_id' => $parentId,
                'order' => 19,
                'title' => 'Pay_Configuration',
                'icon' => 'fa-cc-visa',
                'uri' => 'pay',
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }
        
        // ========== 第三步：注册后台路由（如果需要） ==========
        // 支付配置使用独角卡数原有的 PayController
        // 不需要额外注册路由，但需要确保 app/Admin/routes.php 中有：
        // $router->resource('pay', 'PayController');
        
        // 检查路由文件
        $routeFile = app_path('Admin/routes.php');
        $routeContent = file_get_contents($routeFile);
        
        // 如果路由被注释了，取消注释
        if (strpos($routeContent, "// \$router->resource('pay', 'PayController');") !== false) {
            $routeContent = str_replace(
                "// \$router->resource('pay', 'PayController');",
                "\$router->resource('pay', 'PayController');",
                $routeContent
            );
            file_put_contents($routeFile, $routeContent);
        }
        
        return [
            'success' => true,
            'message' => '支付宝支付插件安装成功！请在"支付配置"中配置应用ID和密钥。'
        ];
        
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => '安装失败：' . $e->getMessage()
        ];
    }
};
```

#### 2. 支付插件的 uninstall.php 模板

```php
<?php
/**
 * 支付插件卸载脚本模板
 * 
 * 功能：
 * 1. 删除支付方式
 * 2. 检查是否还有其他支付插件，如果没有则删除"支付配置"菜单
 */

return function() {
    try {
        $payCheck = 'alipay'; // 支付标识
        
        // ========== 第一步：删除支付方式 ==========
        DB::table('pays')->where('pay_check', $payCheck)->delete();
        
        // ========== 第二步：检查是否还有其他支付方式 ==========
        $remainingPays = DB::table('pays')->count();
        
        // 如果没有了，删除"支付配置"菜单和路由
        if ($remainingPays == 0) {
            // 删除菜单
            DB::table('admin_menu')->where('uri', 'pay')->delete();
            
            // 注释掉路由
            $routeFile = app_path('Admin/routes.php');
            $routeContent = file_get_contents($routeFile);
            
            if (strpos($routeContent, "\$router->resource('pay', 'PayController');") !== false) {
                $routeContent = str_replace(
                    "\$router->resource('pay', 'PayController');",
                    "// \$router->resource('pay', 'PayController'); // 已移除，改为通过支付插件提供",
                    $routeContent
                );
                file_put_contents($routeFile, $routeContent);
            }
        }
        
        return [
            'success' => true,
            'message' => '支付宝支付插件卸载成功！'
        ];
        
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => '卸载失败：' . $e->getMessage()
        ];
    }
};
```

#### 3. 支付插件的 plugin.json 模板

```json
{
  "name": "支付宝支付",
  "slug": "alipay-payment",
  "version": "1.0.0",
  "description": "支持支付宝扫码支付和手机网站支付",
  "author": "独角卡数",
  "requires": "1.0.0",
  "type": "payment",
  "icon": "alipay",
  "is_free": true,
  "settings": {
    "app_id": {
      "label": "应用ID (App ID)",
      "type": "text",
      "required": true,
      "description": "支付宝开放平台应用的 App ID"
    },
    "ali_public_key": {
      "label": "支付宝公钥",
      "type": "textarea",
      "required": true,
      "description": "支付宝开放平台提供的公钥"
    },
    "private_key": {
      "label": "应用私钥",
      "type": "textarea",
      "required": true,
      "description": "应用的私钥（RSA2）"
    }
  }
}
```

#### 4. 支付插件的目录结构

```
public/plugins/alipay-payment/
├── plugin.json              # 插件配置
├── install.php             # 安装脚本（自动创建菜单）
├── uninstall.php          # 卸载脚本（自动删除菜单）
├── routes.php             # 路由定义
├── README.md              # 说明文档
├── AlipayController.php   # 支付控制器
└── icon.png              # 插件图标
```

---

## 🔄 工作流程演示

### 场景1：安装第一个支付插件

**用户操作**：
1. 访问插件市场：`/admin/plugins`
2. 找到"支付宝支付"插件
3. 点击"安装"按钮

**系统自动执行**：
1. 下载插件文件到 `public/plugins/alipay-payment/`
2. 执行 `install.php`：
   - 插入支付方式到 `pays` 表
   - 创建"支付配置"菜单（ID: 21, uri: pay）
   - 取消注释 `$router->resource('pay', 'PayController');`
3. 记录到 `installed_plugins` 表
4. 清除缓存，重启服务

**结果**：
- ✅ 左侧菜单出现"支付配置"
- ✅ 点击进入，看到"支付宝"支付方式
- ✅ 可以配置应用ID、密钥等参数
- ✅ 配置完成后，前台商品页面显示"支付宝"支付方式

### 场景2：安装第二个支付插件

**用户操作**：
1. 访问插件市场
2. 找到"微信支付"插件
3. 点击"安装"

**系统自动执行**：
1. 下载插件文件
2. 执行 `install.php`：
   - 插入"微信支付"到 `pays` 表
   - 检查"支付配置"菜单（已存在，跳过创建）
3. 记录到 `installed_plugins` 表

**结果**：
- ✅ "支付配置"菜单不变
- ✅ 支付方式列表中新增"微信支付"
- ✅ 可以独立配置微信支付参数

### 场景3：卸载所有支付插件

**用户操作**：
1. 卸载"支付宝支付"
2. 卸载"微信支付"

**系统自动执行**：
1. 执行第一个插件的 `uninstall.php`：
   - 删除"支付宝"支付方式
   - 检查还有其他支付方式（有），保留菜单
2. 执行第二个插件的 `uninstall.php`：
   - 删除"微信支付"支付方式
   - 检查还有其他支付方式（没有了）
   - 删除"支付配置"菜单
   - 注释掉路由

**结果**：
- ✅ "支付配置"菜单消失
- ✅ 前台商品页面无支付方式
- ✅ 独角卡数回到"纯净版"状态

---

## 📝 关键技术点

### 1. 菜单自动管理

**创建菜单**：
```php
DB::table('admin_menu')->insert([
    'parent_id' => 19,           // "配置"菜单的ID
    'order' => 19,
    'title' => 'Pay_Configuration',
    'icon' => 'fa-cc-visa',
    'uri' => 'pay',
    'created_at' => now(),
    'updated_at' => now(),
]);
```

**删除菜单**：
```php
DB::table('admin_menu')->where('uri', 'pay')->delete();
```

### 2. 路由自动管理

**取消注释路由**：
```php
$routeContent = str_replace(
    "// \$router->resource('pay', 'PayController');",
    "\$router->resource('pay', 'PayController');",
    $routeContent
);
```

**注释路由**：
```php
$routeContent = str_replace(
    "\$router->resource('pay', 'PayController');",
    "// \$router->resource('pay', 'PayController');",
    $routeContent
);
```

### 3. 支付方式数据结构

**pays 表字段**：
- `pay_name`: 支付方式名称（如"支付宝"）
- `pay_check`: 支付标识（如"alipay"，唯一）
- `pay_method`: 支付方式（1=跳转, 2=扫码）
- `pay_handleroute`: 路由前缀（如"pay/alipay"）
- `merchant_id`: 商户ID（用户配置）
- `merchant_key`: 商户密钥（用户配置）
- `merchant_pem`: 公钥/证书（用户配置）
- `is_open`: 是否启用（0=关闭, 1=开启）

---

## ⚠️ 注意事项

### 1. 菜单ID可能变化
不同环境的"配置"菜单ID可能不同，需要动态查询：
```php
$configMenu = DB::table('admin_menu')
    ->where('title', 'Configuration')
    ->first();
$parentId = $configMenu ? $configMenu->id : 19;
```

### 2. 路由文件权限
确保 `app/Admin/routes.php` 文件有写入权限：
```bash
chmod 666 app/Admin/routes.php
```

### 3. 缓存清理
安装/卸载插件后必须清除缓存：
```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
```

### 4. 并发安装
如果同时安装多个支付插件，需要加锁防止重复创建菜单：
```php
DB::transaction(function() {
    // 创建菜单的代码
});
```

---

## 🎯 下一步计划

### 1. 开发第一个支付插件（支付宝）
- [ ] 创建插件目录结构
- [ ] 编写 plugin.json
- [ ] 编写 install.php（包含自动创建菜单逻辑）
- [ ] 编写 uninstall.php（包含自动删除菜单逻辑）
- [ ] 复制 AlipayController.php
- [ ] 编写 routes.php
- [ ] 测试安装流程

### 2. 测试完整流程
- [ ] 测试安装第一个支付插件（菜单应该出现）
- [ ] 测试配置支付参数
- [ ] 测试前台支付流程
- [ ] 测试安装第二个支付插件（菜单不重复）
- [ ] 测试卸载所有插件（菜单应该消失）

### 3. 批量制作其他支付插件
- [ ] 微信支付
- [ ] TokenPay
- [ ] EPUSDT
- [ ] PayPal
- [ ] Stripe
- [ ] 其他8个支付方式

### 4. 上架到插件市场
- [ ] 打包所有支付插件
- [ ] 上传到授权系统
- [ ] 配置下载地址
- [ ] 测试购买和安装流程

---

**文档版本**：v1.0  
**最后更新**：2025-12-09  
**状态**：第一阶段完成，准备开发第一个支付插件


---

## 🎫 优惠券功能移除记录

**日期**：2025-12-09  
**目标**：移除独角卡数的优惠券功能，将来作为会员系统插件的一部分

### ✅ 已完成工作

#### 1. 备份优惠券文件
```
✅ backup/coupon-feature/CouponController.php  - 后台控制器
✅ backup/coupon-feature/Coupon.php            - 数据模型
```

#### 2. 删除优惠券文件
```
✅ app/Admin/Controllers/CouponController.php  - 已删除
✅ app/Models/Coupon.php                       - 已删除
```

#### 3. 修改路由配置
**文件**：`app/Admin/routes.php`

```php
// 原代码
$router->resource('coupon', 'CouponController');

// 新代码
// $router->resource('coupon', 'CouponController'); // 已移除，改为通过会员系统插件提供
```

#### 4. 清理数据库
```sql
-- 删除优惠券菜单（2个）
DELETE FROM admin_menu WHERE id IN (17, 18);
-- ID 17: Coupon (uri: /coupon)
-- ID 18: Coupon_Manage (父菜单)

-- 清空优惠券数据（保留表结构）
TRUNCATE TABLE coupons;
TRUNCATE TABLE coupons_goods;
```

#### 5. 部署到服务器
```powershell
# 上传路由文件
scp routes.php → 服务器

# 删除文件 + 清理缓存 + 重启
rm CouponController.php Coupon.php
php artisan cache:clear
docker restart php74
```

### 📊 移除效果
- ✅ "优惠管理"菜单消失
- ✅ "优惠码列表"子菜单消失
- ✅ 后台无法访问优惠券功能
- ✅ 前台下单时无法使用优惠券

### 🔄 将来恢复方案

#### 作为会员系统插件的一部分

**插件名称**：会员系统（Member System）  
**包含功能**：
1. 会员等级管理
2. 会员折扣
3. **优惠券系统**（从独角卡数移植）
4. 积分系统
5. 会员专属商品

#### 优惠券功能恢复步骤

**1. 在会员插件的 install.php 中**：

```php
<?php
return function() {
    try {
        // ========== 恢复优惠券菜单 ==========
        
        // 查找"优惠管理"父菜单
        $couponManageMenu = DB::table('admin_menu')
            ->where('title', 'Coupon_Manage')
            ->first();
        
        // 如果不存在，创建父菜单
        if (!$couponManageMenu) {
            $couponManageId = DB::table('admin_menu')->insertGetId([
                'parent_id' => 0,
                'order' => 15,
                'title' => 'Coupon_Manage',
                'icon' => 'fa-diamond',
                'uri' => '',
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        } else {
            $couponManageId = $couponManageMenu->id;
        }
        
        // 创建"优惠券"子菜单
        DB::table('admin_menu')->insert([
            'parent_id' => $couponManageId,
            'order' => 16,
            'title' => 'Coupon',
            'icon' => 'fa-dollar',
            'uri' => 'coupon',
            'created_at' => now(),
            'updated_at' => now(),
        ]);
        
        // ========== 恢复优惠券路由 ==========
        
        // 在会员插件的 routes.php 中注册优惠券路由
        // 或者修改 app/Admin/routes.php，取消注释：
        // $router->resource('coupon', 'CouponController');
        
        return [
            'success' => true,
            'message' => '会员系统安装成功！优惠券功能已恢复。'
        ];
        
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => '安装失败：' . $e->getMessage()
        ];
    }
};
```

**2. 复制优惠券文件到会员插件**：

```
public/plugins/member-system/
├── Controllers/
│   ├── MemberController.php       # 会员管理
│   └── CouponController.php       # 优惠券管理（从 backup 恢复）
├── Models/
│   ├── Member.php
│   ├── MemberLevel.php
│   └── Coupon.php                 # 优惠券模型（从 backup 恢复）
└── ...
```

**3. 修改命名空间**：

```php
// 原命名空间
namespace App\Admin\Controllers;
namespace App\Models;

// 新命名空间
namespace Plugins\MemberSystem\Controllers;
namespace Plugins\MemberSystem\Models;
```

#### 数据库表说明

**保留的表**（将来会员插件使用）：
- `coupons` - 优惠券表
- `coupons_goods` - 优惠券与商品关联表

**表结构**（参考）：
```sql
-- coupons 表
CREATE TABLE `coupons` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `code` varchar(50) UNIQUE NOT NULL COMMENT '优惠码',
  `type` tinyint NOT NULL COMMENT '类型（1=固定金额，2=百分比）',
  `value` decimal(10,2) NOT NULL COMMENT '优惠值',
  `min_amount` decimal(10,2) DEFAULT 0 COMMENT '最低消费金额',
  `max_discount` decimal(10,2) COMMENT '最大优惠金额',
  `total_count` int DEFAULT 0 COMMENT '总数量（0=无限）',
  `used_count` int DEFAULT 0 COMMENT '已使用数量',
  `start_at` timestamp COMMENT '开始时间',
  `expire_at` timestamp COMMENT '过期时间',
  `status` tinyint DEFAULT 1 COMMENT '状态（1=启用，0=禁用）',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_code (code),
  INDEX idx_status (status)
);

-- coupons_goods 表（优惠券适用商品）
CREATE TABLE `coupons_goods` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `coupons_id` bigint NOT NULL,
  `goods_id` bigint NOT NULL,
  `created_at` timestamp,
  FOREIGN KEY (coupons_id) REFERENCES coupons(id),
  FOREIGN KEY (goods_id) REFERENCES goods(id)
);
```

### 📝 注意事项

1. **数据保留**：优惠券表数据已清空，但表结构保留
2. **代码备份**：优惠券代码备份在 `backup/coupon-feature/`
3. **路由注释**：路由已注释，将来取消注释即可
4. **菜单ID**：记录菜单ID（17, 18），将来恢复时参考

### 🎯 与会员系统的集成

**优惠券 + 会员折扣叠加规则**：

```php
// 计算最终价格
$originalPrice = 100;  // 原价

// 1. 先应用会员折扣
$memberDiscount = 0.9;  // VIP 9折
$priceAfterMember = $originalPrice * $memberDiscount;  // 90元

// 2. 再应用优惠券
$couponDiscount = 10;  // 优惠券减10元
$finalPrice = $priceAfterMember - $couponDiscount;  // 80元

// 或者：只能二选一（推荐）
$finalPrice = min(
    $originalPrice * $memberDiscount,  // 会员价
    $originalPrice - $couponDiscount   // 优惠券价
);
```

---

**更新时间**：2025-12-09  
**状态**：优惠券功能已移除，等待会员系统插件开发
