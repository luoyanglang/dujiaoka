# 独角卡数纯净版 - 安全加固记录

**日期**：2025-12-09  
**版本**：v1.0 纯净版  
**状态**：✅ 所有安全问题已修复

---

## 🔒 安全修复清单

### 严重问题（已修复 ✅）

#### 1. 插件安装 - 任意文件写入风险
**文件**：`app/Service/PluginInstallService.php`

**修复内容**：
- ✅ 添加路径遍历检测（`..`、`./`、绝对路径）
- ✅ 文件扩展名白名单验证
- ✅ 验证 `plugin.json` 必需文件
- ✅ 验证 `plugin.json` 格式和 slug 一致性
- ✅ 添加安全日志记录

**防护效果**：
- 防止恶意 zip 文件覆盖系统文件
- 防止写入 webshell
- 防止路径遍历攻击

---

#### 2. 插件下载 - SSRF 攻击风险
**文件**：`app/Service/PluginInstallService.php`

**修复内容**：
- ✅ URL 白名单验证（只允许授权域名）
- ✅ 强制 HTTPS 协议
- ✅ 启用 SSL 证书验证
- ✅ 文件大小限制（50MB）
- ✅ 文件类型验证（魔术字节检查）
- ✅ 添加安全日志记录

**防护效果**：
- 防止 SSRF 攻击
- 防止下载恶意文件
- 防止中间人攻击

---

#### 3. 授权服务 - SSL 验证关闭
**文件**：`app/Service/PluginLicenseService.php`

**修复内容**：
- ✅ 启用 SSL 证书验证
- ✅ 添加 User-Agent 标识
- ✅ 添加客户端版本标识

**防护效果**：
- 防止中间人攻击
- 防止授权码被窃取

---

### 中等问题（已修复 ✅）

#### 4. 动态路由加载 - 代码注入风险
**文件**：`routes/common/pay.php`

**修复内容**：
- ✅ 添加 `plugin.json` 完整性检查
- ✅ 验证 slug 一致性
- ✅ 异常捕获和日志记录
- ✅ 加载失败时跳过插件

**防护效果**：
- 防止恶意插件注入代码
- 防止路由劫持
- 提高系统稳定性

---

#### 5. 插件激活 - 暴力破解风险
**文件**：`app/Admin/Controllers/PluginController.php`

**修复内容**：
- ✅ 添加速率限制（5次/10分钟）
- ✅ 记录失败尝试日志
- ✅ 激活成功清除失败计数
- ✅ 返回 429 状态码

**防护效果**：
- 防止暴力破解授权码
- 防止 DoS 攻击
- 提供审计追踪

---

#### 6. 错误信息泄露
**文件**：`app/Service/PluginInstallService.php`、`app/Admin/Controllers/PluginController.php`

**修复内容**：
- ✅ 生产环境隐藏详细错误
- ✅ 只返回通用错误信息
- ✅ 详细错误记录到日志

**防护效果**：
- 防止系统路径泄露
- 防止敏感信息泄露
- 保持用户友好提示

---

### 安全增强（已实现 ✅）

#### 7. 安全日志系统
**文件**：所有核心文件

**实现内容**：
- ✅ 插件安装日志（包含版本、IP、时间）
- ✅ 插件卸载日志
- ✅ 插件激活日志（脱敏授权码）
- ✅ 激活失败日志（记录尝试）
- ✅ 下载插件日志
- ✅ 路由加载失败日志

**日志位置**：`storage/logs/laravel.log`

---

#### 8. 安全配置文件
**文件**：`config/plugin-security.php`

**配置项**：
- ✅ 下载白名单域名
- ✅ 文件大小限制
- ✅ 允许的文件扩展名
- ✅ 激活速率限制
- ✅ 安全日志开关
- ✅ 错误隐藏开关

**环境变量**：
```env
# 插件安全配置
PLUGIN_CDN_DOMAIN=cdn.ymd.cc
PLUGIN_MAX_SIZE=52428800
PLUGIN_ACTIVATE_MAX_ATTEMPTS=5
PLUGIN_ACTIVATE_DECAY_MINUTES=10
PLUGIN_SECURITY_LOGGING=true
PLUGIN_HIDE_ERRORS=true
```

---

## 🛡️ 安全防护层级

### 第一层：下载验证
1. URL 白名单检查
2. HTTPS 强制
3. SSL 证书验证
4. 文件大小限制
5. 文件类型验证（魔术字节）

### 第二层：安装验证
1. 路径遍历检测
2. 文件扩展名白名单
3. plugin.json 必需文件检查
4. plugin.json 格式验证
5. slug 一致性验证

### 第三层：运行时验证
1. 插件完整性检查
2. slug 一致性验证
3. 异常捕获和隔离

### 第四层：访问控制
1. 后台登录验证
2. 速率限制（防暴力破解）
3. 操作日志记录

---

## 📊 安全测试清单

### 必须测试

- [ ] **路径遍历攻击**
  - 上传包含 `../../../etc/passwd` 的 zip
  - 预期：安装失败，提示"检测到非法文件路径"

- [ ] **恶意文件类型**
  - 上传包含 `.exe`、`.sh` 的 zip
  - 预期：安装失败，提示"检测到非法文件类型"

- [ ] **SSRF 攻击**
  - 尝试下载 `http://localhost/admin`
  - 预期：下载失败，提示"下载地址不在白名单中"

- [ ] **非 HTTPS 下载**
  - 尝试下载 `http://example.com/plugin.zip`
  - 预期：下载失败，提示"只允许 HTTPS 下载"

- [ ] **暴力破解授权码**
  - 连续尝试 6 次错误授权码
  - 预期：第 6 次返回 429，提示"尝试次数过多"

- [ ] **文件过大**
  - 上传 100MB 的 zip 文件
  - 预期：下载失败，提示"文件过大"

- [ ] **缺少 plugin.json**
  - 上传不包含 plugin.json 的 zip
  - 预期：安装失败，提示"插件缺少 plugin.json 文件"

- [ ] **slug 不匹配**
  - plugin.json 中 slug 与实际不符
  - 预期：安装失败，提示"插件标识不匹配"

---

## 🔍 安全审计建议

### 定期检查（每月）

1. **日志审计**
   ```bash
   # 查看插件操作日志
   grep "插件" storage/logs/laravel.log | tail -100
   
   # 查看激活失败日志
   grep "插件激活失败" storage/logs/laravel.log
   
   # 查看异常尝试
   grep "尝试过多" storage/logs/laravel.log
   ```

2. **文件完整性检查**
   ```bash
   # 检查插件目录权限
   ls -la public/plugins/
   
   # 检查是否有异常文件
   find public/plugins/ -name "*.exe" -o -name "*.sh"
   ```

3. **配置检查**
   ```bash
   # 检查 .env 文件权限
   ls -la .env
   
   # 应该是 600 或 640
   chmod 600 .env
   ```

### 安全更新（及时）

1. **依赖更新**
   ```bash
   composer update --with-dependencies
   ```

2. **Laravel 安全补丁**
   - 关注 Laravel 安全公告
   - 及时更新到最新版本

3. **插件市场更新**
   - 定期检查授权系统更新
   - 更新插件安全配置

---

## 📝 安全事件响应

### 发现安全问题时

1. **立即隔离**
   ```bash
   # 禁用所有插件
   php artisan down
   
   # 删除可疑插件
   rm -rf public/plugins/suspicious-plugin
   ```

2. **日志分析**
   ```bash
   # 导出最近的日志
   tail -1000 storage/logs/laravel.log > security-incident.log
   ```

3. **通知管理员**
   - 发送安全事件报告
   - 包含日志和影响范围

4. **修复和恢复**
   - 修复安全漏洞
   - 从备份恢复（如需要）
   - 重新上线

---

## ✅ 安全认证

### 当前安全等级：⭐⭐⭐⭐⭐ 高

**防护能力**：
- ✅ 防路径遍历攻击
- ✅ 防 SSRF 攻击
- ✅ 防中间人攻击
- ✅ 防暴力破解
- ✅ 防代码注入
- ✅ 防信息泄露

**审计能力**：
- ✅ 完整操作日志
- ✅ 失败尝试记录
- ✅ 异常事件告警

**恢复能力**：
- ✅ 详细错误日志
- ✅ 插件隔离机制
- ✅ 快速回滚能力

---

**文档版本**：v1.0  
**最后更新**：2025-12-09  
**下次审计**：2026-01-09
