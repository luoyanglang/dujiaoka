# ç‹¬è§’å¡æ•°æ’ä»¶å¸‚åœºç³»ç»Ÿå¼€å‘æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆå®ç°ç±»ä¼¼ WordPress æ’ä»¶å¸‚åœºçš„åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç‹¬è§’å¡æ•°åå°æµè§ˆã€è´­ä¹°ã€å®‰è£…æ’ä»¶ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ›’ åœ¨çº¿æ’ä»¶å¸‚åœºï¼ˆå…è´¹ + ä»˜è´¹ï¼‰
- ğŸ’³ é›†æˆ TokenPay æ”¯ä»˜ï¼ˆUSDT/TRXï¼‰
- ğŸ” æˆæƒç æ¿€æ´» + åŸŸåç»‘å®š
- ğŸ“¦ çœŸå®ä¸‹è½½å®‰è£…æ’ä»¶æ–‡ä»¶
- ğŸ”’ é˜²ç¯¡æ”¹ä¿æŠ¤ï¼ˆå¤šå±‚å®‰å…¨æœºåˆ¶ï¼‰

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
ç‹¬è§’å¡æ•°æ’ä»¶å¸‚åœº
    â†“
æˆæƒç³»ç»ŸAPIï¼ˆéšè—ï¼Œå®¢æˆ·ä¸å¯è§ï¼‰
    â†“
TokenPayæ”¯ä»˜å¹³å°ï¼ˆUSDT/TRXï¼‰
    â†“
æ”¯ä»˜æˆåŠŸ â†’ ç”Ÿæˆæˆæƒç  â†’ å‘é€é‚®ä»¶ + é¡µé¢æ˜¾ç¤º
    â†“
ç”¨æˆ·è¾“å…¥æˆæƒç  â†’ éªŒè¯åŸŸå â†’ ä¸‹è½½å®‰è£…æ’ä»¶
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. æ’ä»¶å¸‚åœºé¡µé¢
- **æ’ä»¶åˆ—è¡¨å±•ç¤º**ï¼šå¡ç‰‡å¼å¸ƒå±€ï¼Œæ˜¾ç¤ºæ’ä»¶å›¾æ ‡ã€åç§°ã€æè¿°ã€ä»·æ ¼
- **ç­›é€‰åŠŸèƒ½**ï¼šå…¨éƒ¨/å…è´¹/ä»˜è´¹/å·²å®‰è£…
- **æœç´¢åŠŸèƒ½**ï¼šæŒ‰æ’ä»¶åç§°æœç´¢
- **æ’ä»¶è¯¦æƒ…**ï¼šç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä»‹ç»ã€ç‰ˆæœ¬ã€ä½œè€…ã€æˆªå›¾

### 2. æ’ä»¶ç±»å‹
- **å…è´¹æ’ä»¶**ï¼šç›´æ¥ç‚¹å‡»å®‰è£…ï¼Œæ— éœ€æˆæƒç 
- **ä»˜è´¹æ’ä»¶**ï¼šè´­ä¹° â†’ è·å–æˆæƒç  â†’ æ¿€æ´» â†’ å®‰è£…

### 3. æƒé™æ§åˆ¶ âœ… å·²å®ç°
- **ä¸€ç ä¸€æ’ä»¶**ï¼šä¸€ä¸ªæ¿€æ´»ç åªèƒ½æ¿€æ´»å·²è´­ä¹°çš„æ’ä»¶
- **æƒé™éªŒè¯**ï¼šæ¿€æ´»æ—¶éªŒè¯æˆæƒç æ˜¯å¦åŒ…å«è¯¥æ’ä»¶çš„ä½¿ç”¨æƒé™
- **å‹å¥½æç¤º**ï¼šæ˜¾ç¤ºå½“å‰æˆæƒåŒ…å«çš„åŠŸèƒ½ï¼Œæç¤ºéœ€è¦è´­ä¹°çš„æ’ä»¶
- **å¢è´­æ”¯æŒ**ï¼šè´­ä¹°æ–°åŠŸèƒ½åï¼Œæˆæƒç è‡ªåŠ¨å‡çº§ï¼Œå¯æ¿€æ´»æ–°æ’ä»¶

### 4. æ’ä»¶åŒæ­¥ âœ… å·²å®ç°
- **è‡ªåŠ¨åŒæ­¥**ï¼šä»æˆæƒç³»ç»ŸåŒæ­¥æ’ä»¶åˆ—è¡¨
- **æ™ºèƒ½æ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†å·²ä¸‹æ¶çš„æ’ä»¶ï¼ˆåªåˆ é™¤æœªå®‰è£…çš„ï¼‰
- **ä¿æŠ¤æœºåˆ¶**ï¼šå·²å®‰è£…çš„æ’ä»¶ä¸ä¼šè¢«åˆ é™¤ï¼ˆå³ä½¿æˆæƒç³»ç»Ÿä¸‹æ¶äº†ï¼‰

### 5. è´­ä¹°æµç¨‹ï¼ˆä»˜è´¹æ’ä»¶ï¼‰âœ… å·²å®ç°
```
1. åå°ç‚¹å‡»"è´­ä¹°"æŒ‰é’®
2. è·³è½¬åˆ°åå°è´­ä¹°é¡µé¢ï¼ˆéœ€è¦ç™»å½•ï¼Œæœ‰æƒé™ä¿æŠ¤ï¼‰
3. å¡«å†™æ¥æ”¶æˆæƒç çš„é‚®ç®±
4. é€‰æ‹©å¸ç§ï¼šUSDT (TRC20) / TRX
5. ç‚¹å‡»"ç«‹å³è´­ä¹°"åˆ›å»ºè®¢å•
6. æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç  + æ”¶æ¬¾åœ°å€ï¼ˆå¸¦å¤åˆ¶æŒ‰é’®ï¼‰
7. ç³»ç»Ÿè‡ªåŠ¨è½®è¯¢è®¢å•çŠ¶æ€ï¼ˆæ¯10ç§’ï¼‰
8. æ”¯ä»˜æˆåŠŸ â†’ é¡µé¢æ˜¾ç¤ºæˆæƒç  + é‚®ä»¶å‘é€æˆæƒç 
9. ç”¨æˆ·å¤åˆ¶æˆæƒç 
```

**å®ç°æ–¹å¼**ï¼š
- åå°è´­ä¹°é¡µé¢ï¼š`/admin/plugins/{id}/purchase`ï¼ˆéœ€è¦ç™»å½•ï¼‰
- å‰å°é¡µé¢å·²åˆ é™¤ï¼Œåªä¿ç•™APIæ¥å£
- æ”¯ä»˜æ–¹å¼ï¼šä»…æ”¯æŒ TokenPayï¼ˆUSDT/TRXï¼‰

### 6. æ¿€æ´»æµç¨‹ âœ… å·²å®ç°
```
1. è¾“å…¥æˆæƒç 
2. ç³»ç»Ÿè‡ªåŠ¨è·å–å½“å‰åŸŸå
3. è°ƒç”¨æˆæƒç³»ç»ŸéªŒè¯æˆæƒç  + ç»‘å®šåŸŸå
4. éªŒè¯æ’ä»¶æƒé™ï¼ˆæ˜¯å¦è´­ä¹°äº†è¯¥æ’ä»¶ï¼‰âœ… æ–°å¢
5. éªŒè¯æˆåŠŸ â†’ ä¸‹è½½æ’ä»¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
6. è§£å‹å®‰è£… â†’ å¯ç”¨æ’ä»¶
7. å®Œæˆï¼
```

**æƒé™éªŒè¯é€»è¾‘**ï¼š
- æ¿€æ´»æ—¶ä¼ é€’æ’ä»¶çš„ `unique_code`ï¼ˆå¦‚ "tokenpay-payment"ã€"ä¼šå‘˜ç³»ç»Ÿ"ï¼‰
- æˆæƒç³»ç»ŸéªŒè¯æˆæƒç çš„ `features` å­—æ®µæ˜¯å¦åŒ…å«è¯¥ `unique_code`
- å¦‚æœä¸åŒ…å«ï¼Œè¿”å› 403 é”™è¯¯ï¼Œæç¤ºéœ€è¦è´­ä¹°
- å¦‚æœåŒ…å«ï¼Œç»§ç»­ä¸‹è½½å®‰è£…æµç¨‹

**é”™è¯¯æç¤ºç¤ºä¾‹**ï¼š
```
æ‚¨æ²¡æœ‰è´­ä¹°ã€ç§¯åˆ†ç³»ç»Ÿã€‘æ’ä»¶ï¼Œæ— æ³•æ¿€æ´»ã€‚
å½“å‰æˆæƒåŒ…å«çš„åŠŸèƒ½ï¼šä¼šå‘˜ç³»ç»Ÿ, åˆ†é”€ç³»ç»Ÿã€‚
è¯·å…ˆè´­ä¹°ã€ç§¯åˆ†ç³»ç»Ÿã€‘åå†è¿›è¡Œæ¿€æ´»ã€‚
```

### 7. æ’ä»¶ç®¡ç†
- **å·²å®‰è£…æ’ä»¶åˆ—è¡¨**ï¼šæ˜¾ç¤ºæ’ä»¶çŠ¶æ€ã€ç‰ˆæœ¬ã€æˆæƒä¿¡æ¯
- **å¯ç”¨/ç¦ç”¨**ï¼šä¸€é”®å¼€å…³æ’ä»¶
- **å¸è½½æ’ä»¶**ï¼šåˆ é™¤æ’ä»¶æ–‡ä»¶ + æ¸…ç†æ•°æ®åº“
- **æŸ¥çœ‹æˆæƒ**ï¼šæŸ¥çœ‹æˆæƒç ã€ç»‘å®šåŸŸåã€è¿‡æœŸæ—¶é—´ï¼ˆä»˜è´¹æ’ä»¶ï¼‰
- **æ›´æ–°æ’ä»¶**ï¼šæ£€æŸ¥æ–°ç‰ˆæœ¬å¹¶æ›´æ–°

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. æˆæƒç³»ç»ŸAPIéšè—
```php
// .env é…ç½®ï¼ˆå®¢æˆ·æ°¸è¿œçœ‹ä¸åˆ°ï¼‰
LICENSE_API_URL=https://your-license-api.com
LICENSE_API_SECRET=your-secret-key

// æ‰€æœ‰APIè°ƒç”¨é€šè¿‡åç«¯ä»£ç†
// å‰ç«¯åªè°ƒç”¨æœ¬åœ°æ¥å£ï¼š/api/plugin/xxx
// åç«¯è½¬å‘åˆ°æˆæƒç³»ç»Ÿï¼Œå®¢æˆ·æ— æ³•çŸ¥é“çœŸå®APIåœ°å€
```

### 2. é˜²ç¯¡æ”¹ä¿æŠ¤ï¼ˆå¤šå±‚æœºåˆ¶ï¼‰

#### ç¬¬ä¸€å±‚ï¼šæ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
```php
// app/Http/Middleware/PluginMarketGuard.php
// æ¯æ¬¡è¯·æ±‚æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
$requiredFiles = [
    'app/Http/Controllers/PluginMarketController.php',
    'app/Service/PluginLicenseService.php',
];
```

#### ç¬¬äºŒå±‚ï¼šæ–‡ä»¶å“ˆå¸ŒéªŒè¯
```php
// å®‰è£…æ—¶è®°å½•æ–‡ä»¶MD5
cache()->forever('plugin_market_hash', md5_file(...));

// è¿è¡Œæ—¶å¯¹æ¯”MD5
if (md5_file(...) !== cache('plugin_market_hash')) {
    lockSystem('æ–‡ä»¶è¢«ç¯¡æ”¹');
}
```

#### ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“æ ‡è®°
```php
// plugin_market_config è¡¨
market_installed = true
market_version = 1.0.0

// å¯åŠ¨æ—¶æ£€æŸ¥
if (!DB::table('plugin_market_config')->where('key', 'market_installed')->exists()) {
    lockSystem('ç³»ç»Ÿé…ç½®å¼‚å¸¸');
}
```

#### ç¬¬å››å±‚ï¼šæ ¸å¿ƒä»£ç åŠ å¯†ï¼ˆä¸Šçº¿æ—¶ï¼‰
```
ä½¿ç”¨ ionCube æˆ– Zend Guard åŠ å¯†å…³é”®æ–‡ä»¶ï¼š
- PluginMarketGuard.php
- PluginLicenseService.php
- PluginMarketController.php

ç ´è§£æˆæœ¬ï¼š1-2å‘¨ + $500ï¼ˆè§£å¯†å·¥å…·ï¼‰
```

#### ç¬¬äº”å±‚ï¼šå»¶è¿Ÿè§¦å‘ï¼ˆå¯é€‰ï¼‰
```php
// æ£€æµ‹åˆ°ç¯¡æ”¹ä¸ç«‹å³é”å®šï¼Œè€Œæ˜¯7å¤©åé”å®š
// è®©ç ´è§£è€…ä»¥ä¸ºæˆåŠŸäº†ï¼Œå®é™…åŸ‹äº†å®šæ—¶ç‚¸å¼¹
if (æ–‡ä»¶è¢«ç¯¡æ”¹) {
    cache()->put('system_compromised', time(), now()->addDays(7));
}
```

### 3. åŸŸåç»‘å®šéªŒè¯
```php
// æ¿€æ´»æ—¶è‡ªåŠ¨è·å–å½“å‰åŸŸå
$domain = request()->getHost();

// è°ƒç”¨æˆæƒç³»ç»ŸéªŒè¯ + ç»‘å®š
POST /api/licenses/activate
{
    "license_key": "xxx",
    "domain": "example.com"
}

// ä¸€ä¸ªæˆæƒç åªèƒ½ç»‘å®šä¸€ä¸ªåŸŸå
// åŸŸåä¸åŒ¹é…æ—¶æ¿€æ´»å¤±è´¥
```

## ï¿½ æ•°è¦æ®åº“è®¾è®¡

### 1. æ’ä»¶è¡¨ï¼ˆpluginsï¼‰
```sql
CREATE TABLE `plugins` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT 'æ’ä»¶åç§°',
  `slug` varchar(50) UNIQUE NOT NULL COMMENT 'æ’ä»¶æ ‡è¯†',
  `description` text COMMENT 'æ’ä»¶æè¿°',
  `version` varchar(20) COMMENT 'ç‰ˆæœ¬å·',
  `price` decimal(10,2) DEFAULT 0 COMMENT 'ä»·æ ¼',
  `is_free` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å…è´¹',
  `author` varchar(50) COMMENT 'ä½œè€…',
  `download_url` varchar(255) COMMENT 'ä¸‹è½½åœ°å€',
  `icon` varchar(255) COMMENT 'å›¾æ ‡',
  `status` enum('active','inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_slug (slug),
  INDEX idx_status (status)
);
```

### 2. å·²å®‰è£…æ’ä»¶è¡¨ï¼ˆinstalled_pluginsï¼‰
```sql
CREATE TABLE `installed_plugins` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `plugin_slug` varchar(50) NOT NULL COMMENT 'æ’ä»¶æ ‡è¯†',
  `license_key` varchar(255) COMMENT 'æˆæƒç ï¼ˆä»˜è´¹æ’ä»¶ï¼‰',
  `domain` varchar(100) COMMENT 'ç»‘å®šåŸŸå',
  `status` enum('active','inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `activated_at` timestamp COMMENT 'æ¿€æ´»æ—¶é—´',
  `expire_at` timestamp COMMENT 'è¿‡æœŸæ—¶é—´',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_plugin_slug (plugin_slug),
  INDEX idx_license_key (license_key),
  INDEX idx_domain (domain)
);
```

### 3. æ’ä»¶å¸‚åœºé…ç½®è¡¨ï¼ˆplugin_market_configï¼‰
```sql
CREATE TABLE `plugin_market_config` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `key` varchar(50) UNIQUE NOT NULL COMMENT 'é…ç½®é”®',
  `value` text COMMENT 'é…ç½®å€¼',
  `created_at` timestamp,
  `updated_at` timestamp
);

-- åˆå§‹æ•°æ®
INSERT INTO plugin_market_config (key, value) VALUES
('market_installed', 'true'),
('market_version', '1.0.0');
```

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

```
dujiaoka-master/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ Admin/Controllers/
â”‚   â”‚   â””â”€â”€ PluginController.php              # åå°æ’ä»¶ç®¡ç†æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ Http/
â”‚   â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â”‚   â””â”€â”€ PluginMarketController.php    # å‰å°æ’ä»¶å¸‚åœºæ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ Middleware/
â”‚   â”‚       â””â”€â”€ PluginMarketGuard.php         # é˜²ç¯¡æ”¹ä¸­é—´ä»¶ï¼ˆåŠ å¯†ï¼‰
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ Plugin.php                        # æ’ä»¶æ¨¡å‹
â”‚   â”‚   â””â”€â”€ InstalledPlugin.php               # å·²å®‰è£…æ’ä»¶æ¨¡å‹
â”‚   â””â”€â”€ Service/
â”‚       â”œâ”€â”€ PluginLicenseService.php          # æˆæƒæœåŠ¡ï¼ˆåŠ å¯†ï¼‰
â”‚       â””â”€â”€ PluginInstallService.php          # æ’ä»¶å®‰è£…æœåŠ¡
â”œâ”€â”€ resources/views/
â”‚   â””â”€â”€ unicorn/
â”‚       â””â”€â”€ plugins/
â”‚           â”œâ”€â”€ market.blade.php              # æ’ä»¶å¸‚åœºé¡µé¢
â”‚           â”œâ”€â”€ detail.blade.php              # æ’ä»¶è¯¦æƒ…é¡µé¢
â”‚           â”œâ”€â”€ purchase.blade.php            # è´­ä¹°é¡µé¢
â”‚           â”œâ”€â”€ activate.blade.php            # æ¿€æ´»é¡µé¢
â”‚           â””â”€â”€ installed.blade.php           # å·²å®‰è£…æ’ä»¶é¡µé¢
â”œâ”€â”€ public/
â”‚   â””â”€â”€ plugins/                              # æ’ä»¶å®‰è£…ç›®å½•
â”‚       â”œâ”€â”€ plugin-slug-1/                    # æ’ä»¶1ç›®å½•
â”‚       â””â”€â”€ plugin-slug-2/                    # æ’ä»¶2ç›®å½•
â”œâ”€â”€ database/migrations/
â”‚   â””â”€â”€ 2025_12_07_000001_create_plugins_tables.php
â””â”€â”€ routes/
    â””â”€â”€ web.php                               # è·¯ç”±é…ç½®
```

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æˆæƒç³»ç»Ÿç«¯ï¼ˆå·²å®Œæˆâœ…ï¼‰

#### å·²å®ç°åŠŸèƒ½
- âœ… è®¢å•ç®¡ç†ï¼ˆordersè¡¨ï¼‰
- âœ… åŠŸèƒ½ç®¡ç†ï¼ˆfeaturesè¡¨ï¼‰
- âœ… å…¬å¼€è´­ä¹°æ¥å£ï¼ˆ/api/public/create-orderï¼‰
- âœ… TokenPayæ”¯ä»˜å›è°ƒï¼ˆ/api/public/tokenpay-callbackï¼‰
- âœ… è®¢å•çŠ¶æ€æŸ¥è¯¢ï¼ˆ/api/public/order-status/:order_noï¼‰
- âœ… è·å–åŠŸèƒ½åˆ—è¡¨ï¼ˆ/api/public/featuresï¼‰
- âœ… æˆæƒç”Ÿæˆå’Œæ¿€æ´»ï¼ˆ/api/licenses/generate, /api/licenses/activateï¼‰
- âœ… åŸŸåç»‘å®šéªŒè¯
- âœ… é‚®ä»¶é€šçŸ¥åŠŸèƒ½

#### APIæ¥å£ï¼ˆä¾›ç‹¬è§’å¡æ•°è°ƒç”¨ï¼‰
```
GET  /api/public/features              # è·å–æ’ä»¶åˆ—è¡¨
POST /api/public/create-order          # åˆ›å»ºè®¢å•
GET  /api/public/order-status/:order_no # æŸ¥è¯¢è®¢å•çŠ¶æ€
POST /api/licenses/activate            # æ¿€æ´»æˆæƒç 
POST /api/licenses/verify              # éªŒè¯æˆæƒ
```

### 2. ç‹¬è§’å¡æ•°æ’ä»¶ç«¯ï¼ˆå¾…å¼€å‘ï¼‰

#### 2.1 æ•°æ®æ¨¡å‹ï¼ˆModelsï¼‰
```php
// app/Models/Plugin.php
class Plugin extends Model
{
    protected $fillable = [
        'name', 'slug', 'description', 'version',
        'price', 'is_free', 'author', 'download_url',
        'icon', 'status'
    ];
    
    public function isInstalled() { ... }
    public function isFree() { ... }
}

// app/Models/InstalledPlugin.php
class InstalledPlugin extends Model
{
    protected $fillable = [
        'plugin_slug', 'license_key', 'domain',
        'status', 'activated_at', 'expire_at'
    ];
    
    public function plugin() { ... }
    public function isActive() { ... }
    public function isExpired() { ... }
}
```

#### 2.2 æœåŠ¡å±‚ï¼ˆServicesï¼‰
```php
// app/Service/PluginLicenseService.phpï¼ˆåŠ å¯†ï¼‰
class PluginLicenseService
{
    // APIä»£ç†ï¼Œéšè—çœŸå®æˆæƒç³»ç»Ÿåœ°å€
    public function getPluginList() { ... }
    public function createOrder($email, $feature, $currency) { ... }
    public function checkOrderStatus($orderNo) { ... }
    public function activateLicense($licenseKey, $domain) { ... }
    public function verifyLicense($licenseKey, $domain) { ... }
}

// app/Service/PluginInstallService.php
class PluginInstallService
{
    public function downloadPlugin($downloadUrl) { ... }
    public function installPlugin($pluginSlug, $zipFile) { ... }
    public function uninstallPlugin($pluginSlug) { ... }
    public function enablePlugin($pluginSlug) { ... }
    public function disablePlugin($pluginSlug) { ... }
}
```

#### 2.3 æ§åˆ¶å™¨ï¼ˆControllersï¼‰
```php
// app/Http/Controllers/PluginMarketController.php
class PluginMarketController extends Controller
{
    // æ’ä»¶å¸‚åœºé¦–é¡µ
    public function index() { ... }
    
    // æ’ä»¶è¯¦æƒ…
    public function show($slug) { ... }
    
    // è´­ä¹°é¡µé¢
    public function purchase($slug) { ... }
    
    // åˆ›å»ºè®¢å•ï¼ˆä»£ç†åˆ°æˆæƒç³»ç»Ÿï¼‰
    public function createOrder(Request $request) { ... }
    
    // æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼ˆä»£ç†åˆ°æˆæƒç³»ç»Ÿï¼‰
    public function checkOrder($orderNo) { ... }
    
    // æ¿€æ´»é¡µé¢
    public function activate($slug) { ... }
    
    // æ¿€æ´»æˆæƒç 
    public function doActivate(Request $request) { ... }
    
    // å®‰è£…æ’ä»¶ï¼ˆå…è´¹æ’ä»¶ç›´æ¥å®‰è£…ï¼Œä»˜è´¹æ’ä»¶éœ€å…ˆæ¿€æ´»ï¼‰
    public function install($slug) { ... }
    
    // å¸è½½æ’ä»¶
    public function uninstall($slug) { ... }
    
    // å¯ç”¨/ç¦ç”¨æ’ä»¶
    public function toggle($slug) { ... }
}

// app/Admin/Controllers/PluginController.php
class PluginController extends AdminController
{
    // åå°æ’ä»¶ç®¡ç†åˆ—è¡¨
    public function index() { ... }
    
    // åŒæ­¥æ’ä»¶åˆ—è¡¨ï¼ˆä»æˆæƒç³»ç»Ÿï¼‰
    public function sync() { ... }
}
```

#### 2.4 ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰
```php
// app/Http/Middleware/PluginMarketGuard.phpï¼ˆåŠ å¯†ï¼‰
class PluginMarketGuard
{
    public function handle($request, Closure $next)
    {
        // æ£€æŸ¥1ï¼šæ ¸å¿ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        $this->checkFiles();
        
        // æ£€æŸ¥2ï¼šæ–‡ä»¶å®Œæ•´æ€§ï¼ˆMD5ï¼‰
        $this->checkIntegrity();
        
        // æ£€æŸ¥3ï¼šæ•°æ®åº“æ ‡è®°
        $this->checkDatabase();
        
        return $next($request);
    }
    
    private function lockSystem($reason) { ... }
}
```

#### 2.5 å‰ç«¯é¡µé¢ï¼ˆViewsï¼‰âœ… å·²å®ç°
```php
// åå°è´­ä¹°é¡µé¢ï¼ˆå”¯ä¸€çš„å‰ç«¯é¡µé¢ï¼‰
// resources/views/admin/plugins/purchase-form.blade.php
// - å¡«å†™é‚®ç®±ã€é€‰æ‹©å¸ç§
// - æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç ï¼ˆQRCode.jsç”Ÿæˆï¼‰
// - æ˜¾ç¤ºæ”¶æ¬¾åœ°å€ï¼ˆå¸¦å¤åˆ¶æŒ‰é’®ï¼‰
// - è‡ªåŠ¨è½®è¯¢è®¢å•çŠ¶æ€
// - æ”¯ä»˜æˆåŠŸæ˜¾ç¤ºæˆæƒç 

// å‰å°é¡µé¢å·²å…¨éƒ¨åˆ é™¤ï¼š
// âŒ market.blade.php - å·²åˆ é™¤
// âŒ detail.blade.php - å·²åˆ é™¤
// âŒ purchase.blade.php - å·²åˆ é™¤
// âŒ activate.blade.php - å·²åˆ é™¤
// âŒ installed.blade.php - å·²åˆ é™¤
```

**è®¾è®¡ç†å¿µ**ï¼š
- åªåœ¨åå°è´­ä¹°ï¼Œæœ‰æƒé™ä¿æŠ¤
- å‰å°ä¸æš´éœ²ä»»ä½•è´­ä¹°å…¥å£
- APIæ¥å£ä¿ç•™ï¼Œä¾›åå°è°ƒç”¨

#### 2.6 è·¯ç”±é…ç½® âœ… å·²å®ç°
```php
// routes/common/web.php

// å‰å°è·¯ç”±å·²å…¨éƒ¨åˆ é™¤ï¼Œåªä¿ç•™APIæ¥å£
Route::group(['middleware' => ['dujiaoka.boot']], function () {
    // APIæ¥å£ï¼ˆä¾›åå°è°ƒç”¨ï¼‰
    Route::post('api/plugin/create-order', '\App\Http\Controllers\PluginMarketController@createOrder');
    Route::get('api/plugin/check-order/{orderNo}', '\App\Http\Controllers\PluginMarketController@checkOrder');
    Route::post('api/plugin/activate', '\App\Http\Controllers\PluginMarketController@doActivate');
    Route::post('api/plugin/install/{slug}', '\App\Http\Controllers\PluginMarketController@install');
    Route::post('api/plugin/uninstall/{slug}', '\App\Http\Controllers\PluginMarketController@uninstall');
    Route::post('api/plugin/toggle/{slug}', '\App\Http\Controllers\PluginMarketController@toggle');
});

// åå°è·¯ç”±ï¼ˆDcat Adminè‡ªåŠ¨æ³¨å†Œï¼‰
// /admin/plugins - æ’ä»¶åˆ—è¡¨
// /admin/plugins/{id}/purchase - è´­ä¹°é¡µé¢
// /admin/plugins/sync - åŒæ­¥æ’ä»¶åˆ—è¡¨
// /admin/plugins/{id}/install - å®‰è£…æ’ä»¶
// /admin/plugins/{id}/uninstall - å¸è½½æ’ä»¶
// /admin/plugins/{id}/enable - å¯ç”¨æ’ä»¶
// /admin/plugins/{id}/disable - ç¦ç”¨æ’ä»¶
```

## ï¿½  ç¯å¢ƒé…ç½®

### .env é…ç½®ï¼ˆç‹¬è§’å¡æ•°ï¼‰
```env
# æˆæƒç³»ç»ŸAPIé…ç½®ï¼ˆå®¢æˆ·ä¸å¯è§ï¼‰
LICENSE_API_URL=https://your-license-api.com
LICENSE_API_SECRET=your-secret-key

# æ’ä»¶ä¸‹è½½é…ç½®
PLUGIN_STORAGE_PATH=public/plugins
PLUGIN_DOWNLOAD_TIMEOUT=300
```

## ğŸš€ å¼€å‘è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæˆæƒç³»ç»Ÿç«¯ âœ… å·²å®Œæˆ
- âœ… è®¢å•ç®¡ç†ï¼ˆordersè¡¨ï¼‰
- âœ… åŠŸèƒ½ç®¡ç†ï¼ˆfeaturesè¡¨ï¼‰
- âœ… TokenPayæ”¯ä»˜é›†æˆ
- âœ… å…¬å¼€è´­ä¹°æ¥å£
- âœ… æˆæƒç”Ÿæˆå’Œæ¿€æ´»
- âœ… é‚®ä»¶é€šçŸ¥åŠŸèƒ½

### é˜¶æ®µäºŒï¼šç‹¬è§’å¡æ•°æ’ä»¶ç«¯ï¼ˆå½“å‰é˜¶æ®µï¼‰

#### ç¬¬1æ­¥ï¼šæ•°æ®åº“å’Œæ¨¡å‹ âœ… å·²å®Œæˆï¼ˆæœªæµ‹è¯•ï¼‰
- [x] åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶
- [x] åˆ›å»º Plugin æ¨¡å‹
- [x] åˆ›å»º InstalledPlugin æ¨¡å‹

#### ç¬¬2æ­¥ï¼šæœåŠ¡å±‚ âœ… å·²å®Œæˆï¼ˆæœªæµ‹è¯•ï¼‰
- [x] PluginLicenseServiceï¼ˆAPIä»£ç†ï¼‰
  - [x] getPluginList() - è·å–æ’ä»¶åˆ—è¡¨
  - [x] createOrder($email, $feature, $paymentMethod, $currency) - åˆ›å»ºè®¢å•
    - æ”¯æŒ tokenpay / wechat / alipay
    - TokenPayéœ€è¦ä¼ å¸ç§ï¼ˆUSDT_TRC20 / TRXï¼‰
  - [x] checkOrderStatus() - æŸ¥è¯¢è®¢å•çŠ¶æ€
  - [x] activateLicense() - æ¿€æ´»æˆæƒç 
  - [x] verifyLicense() - éªŒè¯æˆæƒ
- [x] PluginInstallServiceï¼ˆæ’ä»¶å®‰è£…ï¼‰
  - [x] downloadPlugin() - ä¸‹è½½æ’ä»¶
  - [x] installPlugin() - å®‰è£…æ’ä»¶
  - [x] uninstallPlugin() - å¸è½½æ’ä»¶
  - [x] enablePlugin() - å¯ç”¨æ’ä»¶
  - [x] disablePlugin() - ç¦ç”¨æ’ä»¶

#### ç¬¬3æ­¥ï¼šæ§åˆ¶å™¨ âœ… å·²å®Œæˆï¼ˆå·²éƒ¨ç½²ï¼‰
- [x] PluginMarketControllerï¼ˆå‰å°ï¼‰
  - [x] index() - æ’ä»¶å¸‚åœºé¦–é¡µ
  - [x] show() - æ’ä»¶è¯¦æƒ…
  - [x] purchase() - è´­ä¹°é¡µé¢
  - [x] createOrder() - åˆ›å»ºè®¢å•ï¼ˆAPIä»£ç†ï¼‰
  - [x] checkOrder() - æŸ¥è¯¢è®¢å•ï¼ˆAPIä»£ç†ï¼‰
  - [x] activate() - æ¿€æ´»é¡µé¢
  - [x] doActivate() - æ¿€æ´»æˆæƒç 
  - [x] install() - å®‰è£…æ’ä»¶
  - [x] uninstall() - å¸è½½æ’ä»¶
  - [x] toggle() - å¯ç”¨/ç¦ç”¨
- [x] PluginControllerï¼ˆåå°ï¼‰âœ… å·²éƒ¨ç½²
  - [x] index() - æ’ä»¶ç®¡ç†åˆ—è¡¨ï¼ˆåå°é¡µé¢å¯è®¿é—®ï¼‰
  - [x] sync() - åŒæ­¥æ’ä»¶åˆ—è¡¨
  - [x] enable() - å¯ç”¨æ’ä»¶
  - [x] disable() - ç¦ç”¨æ’ä»¶
  - [x] uninstall() - å¸è½½æ’ä»¶

#### ç¬¬4æ­¥ï¼šå‰ç«¯é¡µé¢ âœ… å·²å®Œæˆ
- [x] purchase-form.blade.php - åå°è´­ä¹°é¡µé¢ï¼ˆå”¯ä¸€çš„å‰ç«¯é¡µé¢ï¼‰
  - [x] å¡«å†™é‚®ç®±ã€é€‰æ‹©å¸ç§
  - [x] ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç 
  - [x] æ˜¾ç¤ºæ”¶æ¬¾åœ°å€ï¼ˆå¸¦å¤åˆ¶æŒ‰é’®ï¼‰
  - [x] è‡ªåŠ¨è½®è¯¢è®¢å•çŠ¶æ€ï¼ˆæ¯10ç§’ï¼‰
  - [x] æ”¯ä»˜æˆåŠŸæ˜¾ç¤ºæˆæƒç 
  - [x] æ‰‹åŠ¨åˆ·æ–°è®¢å•çŠ¶æ€æŒ‰é’®
- [x] å‰å°é¡µé¢å·²å…¨éƒ¨åˆ é™¤ï¼ˆmarket/detail/purchase/activate/installedï¼‰

**è®¾è®¡å†³ç­–**ï¼š
- åªåœ¨åå°è´­ä¹°ï¼Œæœ‰æƒé™ä¿æŠ¤ âœ…
- å‰å°ä¸æš´éœ²ä»»ä½•è´­ä¹°å…¥å£ âœ…
- ç®€åŒ–æ¶æ„ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬ âœ…

#### ç¬¬5æ­¥ï¼šé˜²ç¯¡æ”¹ä¸­é—´ä»¶ âœ… å·²å®Œæˆï¼ˆæœªæµ‹è¯•ï¼‰
- [x] PluginMarketGuard ä¸­é—´ä»¶
  - [x] æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
  - [x] æ–‡ä»¶å“ˆå¸ŒéªŒè¯
  - [x] æ•°æ®åº“æ ‡è®°æ£€æŸ¥
  - [x] ç³»ç»Ÿé”å®šæœºåˆ¶

#### ç¬¬6æ­¥ï¼šè·¯ç”±é…ç½® âœ… å·²å®Œæˆ
- [x] å‰å°è·¯ç”±ï¼ˆæ’ä»¶å¸‚åœºã€è¯¦æƒ…ã€è´­ä¹°ã€æ¿€æ´»ï¼‰
- [x] APIè·¯ç”±ï¼ˆè®¢å•ã€æ¿€æ´»ã€å®‰è£…ï¼‰
- [x] åå°è·¯ç”±ï¼ˆæ’ä»¶ç®¡ç†ï¼‰- `app/Admin/routes.php`

#### ç¬¬7æ­¥ï¼šåå°èœå• âœ… å·²å®Œæˆ
- [x] Dcat Admin æ·»åŠ æ’ä»¶ç®¡ç†èœå•ï¼ˆå·²é€šè¿‡ SQL æ·»åŠ ï¼‰
- [x] é…ç½®æƒé™ï¼ˆç®¡ç†å‘˜å¯è®¿é—®ï¼‰
- [x] åå°é¡µé¢å¯æ­£å¸¸è®¿é—®ï¼š`/admin/plugins`

#### ç¬¬8æ­¥ï¼šéƒ¨ç½²è„šæœ¬ âœ… å·²å®Œæˆ
- [x] deploy-plugin-market.shï¼ˆLinuxï¼‰
- [x] deploy-plugin-market.batï¼ˆWindowsï¼‰
- [x] .gitignore æ›´æ–°
- [x] æ’ä»¶ç›®å½•åˆ›å»º

### é˜¶æ®µä¸‰ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å¤©ï¼‰
- [ ] åŠŸèƒ½æµ‹è¯•
  - [ ] å…è´¹æ’ä»¶å®‰è£…æµç¨‹
  - [ ] ä»˜è´¹æ’ä»¶è´­ä¹°æµç¨‹
  - [ ] TokenPayæ”¯ä»˜æµ‹è¯•
  - [ ] æˆæƒç æ¿€æ´»æµ‹è¯•
  - [ ] åŸŸåç»‘å®šéªŒè¯
  - [ ] æ’ä»¶å¸è½½æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•
  - [ ] é˜²ç¯¡æ”¹æœºåˆ¶æµ‹è¯•
  - [ ] APIä»£ç†éšè—æµ‹è¯•
  - [ ] æˆæƒéªŒè¯æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
  - [ ] æ’ä»¶åˆ—è¡¨ç¼“å­˜
  - [ ] ä¸‹è½½é€Ÿåº¦ä¼˜åŒ–

### é˜¶æ®µå››ï¼šä¸Šçº¿éƒ¨ç½²ï¼ˆåŠå¤©ï¼‰
- [ ] ä»£ç åŠ å¯†ï¼ˆionCubeï¼‰
  - [ ] PluginMarketGuard.php
  - [ ] PluginLicenseService.php
  - [ ] PluginMarketController.php
- [ ] ç¯å¢ƒé…ç½®
  - [ ] .env é…ç½®æˆæƒç³»ç»ŸAPI
  - [ ] åˆ›å»ºæ’ä»¶ç›®å½•
  - [ ] è®¾ç½®æ–‡ä»¶æƒé™
- [ ] æ•°æ®åº“è¿ç§»
- [ ] åˆå§‹åŒ–æ’ä»¶åˆ—è¡¨
- [ ] ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

## ğŸ“Š å¼€å‘è¿›åº¦

**æ€»é¢„è®¡æ—¶é—´**ï¼š2-3å¤©

- âœ… é˜¶æ®µä¸€ï¼šå·²å®Œæˆï¼ˆæˆæƒç³»ç»Ÿç«¯ï¼‰
- âœ… é˜¶æ®µäºŒï¼šå·²å®Œæˆï¼ˆ100% - åå°è´­ä¹°åŠŸèƒ½å·²å®ç°ï¼‰
  - âœ… æ•°æ®åº“å’Œæ¨¡å‹ï¼ˆå·²è¿ç§»ï¼‰
  - âœ… æœåŠ¡å±‚ï¼ˆPluginLicenseServiceã€PluginInstallServiceï¼‰
  - âœ… æ§åˆ¶å™¨ï¼ˆPluginControllerã€PluginMarketControllerï¼‰
  - âœ… é˜²ç¯¡æ”¹ä¸­é—´ä»¶ï¼ˆPluginMarketGuardï¼‰
  - âœ… éƒ¨ç½²è„šæœ¬ï¼ˆdeploy-plugin-market.sh/batï¼‰
  - âœ… è·¯ç”±é…ç½®ï¼ˆAPIæ¥å£ + åå°è·¯ç”±ï¼‰
  - âœ… åå°èœå•ï¼ˆæ’ä»¶ç®¡ç†èœå•ï¼‰
  - âœ… åå°è´­ä¹°é¡µé¢ï¼ˆpurchase-form.blade.phpï¼‰
  - âœ… åå°æ¿€æ´»é¡µé¢ï¼ˆactivate-form.blade.phpï¼‰
  - âœ… è´­ä¹°æµç¨‹æµ‹è¯•é€šè¿‡
  - âœ… å‰å°é¡µé¢å·²åˆ é™¤ï¼ˆåªä¿ç•™APIï¼‰
  - âœ… æ’ä»¶åŒæ­¥åŠŸèƒ½ï¼ˆä½¿ç”¨ unique_code ä¿æŒä¸€è‡´ï¼‰
  - â¸ï¸ æ’ä»¶å®‰è£…åŠŸèƒ½ï¼ˆå¾…æµ‹è¯•ï¼‰
- â¸ï¸ é˜¶æ®µä¸‰ï¼šå¾…å¼€å§‹ï¼ˆåŠŸèƒ½æµ‹è¯•å’Œä¼˜åŒ–ï¼‰
- â¸ï¸ é˜¶æ®µå››ï¼šå¾…å¼€å§‹ï¼ˆä¸Šçº¿éƒ¨ç½²ï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æœåŠ¡å™¨ç¯å¢ƒå·²é…ç½®ï¼ˆPHP 7.4 + host ç½‘ç»œ + pdo_mysqlï¼‰
- âœ… æ•°æ®åº“è¿ç§»å·²å®Œæˆï¼ˆpluginsã€installed_plugins è¡¨å·²åˆ›å»ºï¼‰
- âœ… åå°æ’ä»¶ç®¡ç†é¡µé¢å¯è®¿é—®ï¼ˆ/admin/pluginsï¼‰
- âœ… æˆæƒç³»ç»Ÿé…ç½®å®Œæˆï¼ˆ.env å·²é…ç½®ï¼‰
- âœ… åå°è´­ä¹°é¡µé¢å·²å®Œæˆï¼ˆ/admin/plugins/{id}/purchaseï¼‰
- âœ… åå°æ¿€æ´»é¡µé¢å·²å®Œæˆï¼ˆ/admin/plugins/{id}/activateï¼‰
- âœ… è´­ä¹°æµç¨‹å·²æµ‹è¯•é€šè¿‡ï¼ˆåˆ›å»ºè®¢å• â†’ æ”¯ä»˜ â†’ æ˜¾ç¤ºæˆæƒç ï¼‰
- âœ… å‰å°é¡µé¢å·²å…¨éƒ¨åˆ é™¤ï¼Œåªä¿ç•™APIæ¥å£
- âœ… æ’ä»¶åŒæ­¥åŠŸèƒ½å®Œå–„ï¼ˆæ‰€æœ‰å­—æ®µä¸æˆæƒç³»ç»Ÿä¿æŒä¸€è‡´ï¼‰
- âœ… å…è´¹æ’ä»¶å®‰è£…åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼ˆTokenPay æ”¯ä»˜æ’ä»¶ï¼‰
- âœ… ä»˜è´¹æ’
- âœ… åŸŸåç»‘å®šåŠŸèƒ½æ­£å¸¸ï¼ˆæˆæƒç ç»‘å®šåˆ°æŒ‡å®šåŸŸåï¼‰

**é‡è¦ä¿®å¤è®°å½•ï¼ˆ2025-12-08ï¼‰**ï¼š
1. âœ… ä¿®å¤æ’ä»¶æ ‡è¯†ä¸ä¸€è‡´é—®é¢˜ï¼šä½¿ç”¨æˆæƒç³»ç»Ÿçš„ `unique_code` è€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ `plugin-{id}`
2. âœ… å®Œå–„åŒæ­¥é€»è¾‘ï¼šåŒæ­¥æ‰€æœ‰å­—æ®µï¼ˆname, unique_code, description, version, price, author, download_url, statusï¼‰
3. âœ… æ·»åŠ æˆæƒéªŒè¯ï¼šæ¿€æ´»æ—¶è°ƒç”¨æˆæƒç³»ç»ŸéªŒè¯æˆæƒç å¹¶ç»‘å®šåŸŸå
4. âœ… æ¸…ç†æ—§æ•°æ®ï¼šåˆ é™¤æ—§çš„ plugin-* æ ¼å¼çš„æ’ä»¶æ•°æ®
5. âœ… ä¿®å¤ä¸‹è½½åœ°å€é—®é¢˜ï¼šæˆæƒç³»ç»Ÿ API é»˜è®¤è¿”å› `download_url`ï¼ˆ`include_download_url=True`ï¼‰
6. âœ… å…è´¹æ’ä»¶æµ‹è¯•é€šè¿‡ï¼šTokenPay æ”¯ä»˜æ’ä»¶å®‰è£…æˆåŠŸ

## ğŸ’¡ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. APIåœ°å€éšè—
```php
// âŒ é”™è¯¯ï¼šå‰ç«¯ç›´æ¥è°ƒç”¨æˆæƒç³»ç»Ÿä»¶å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼ˆä¼šå‘˜ç³»ç»Ÿï¼šè´­ä¹° â†’ æ¿€æ´» â†’ å®‰è£…ï¼‰
- âœ… æœºå™¨ç ç»‘å®šåŠŸèƒ½æ­£å¸¸ï¼ˆé˜²æ­¢ä¸€ä¸ªæˆæƒç å¤šæœåŠ¡å™¨ä½¿ç”¨ï¼‰
fetch('https://license-api.com/api/public/features')

// âœ… æ­£ç¡®ï¼šé€šè¿‡åç«¯ä»£ç†
fetch('/api/plugin/features')  // åç«¯è½¬å‘åˆ°æˆæƒç³»ç»Ÿ
```

### 2. åŸŸåè‡ªåŠ¨è·å–
```php
// æ¿€æ´»æ—¶è‡ªåŠ¨è·å–å½“å‰åŸŸå
$domain = request()->getHost();  // ä¾‹å¦‚ï¼šshop.example.com
```

### 3. æ’ä»¶å®‰è£…è·¯å¾„
```php
// æ’ä»¶å®‰è£…åˆ° public/plugins/ ç›®å½•
public/plugins/
â”œâ”€â”€ member-system/      # ä¼šå‘˜ç³»ç»Ÿæ’ä»¶
â”‚   â”œâ”€â”€ plugin.php      # æ’ä»¶ä¸»æ–‡ä»¶
â”‚   â”œâ”€â”€ config.php      # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ ...
â””â”€â”€ distribution-system/ # åˆ†é”€ç³»ç»Ÿæ’ä»¶
```

### 4. é˜²ç¯¡æ”¹æœºåˆ¶
```php
// ä¸­é—´ä»¶æ³¨å†Œåˆ°å…¨å±€ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
protected $middleware = [
    \App\Http\Middleware\PluginMarketGuard::class,
    // ...
];
```

### 5. é”™è¯¯å¤„ç†
```php
// æ‰€æœ‰APIè°ƒç”¨éƒ½è¦æœ‰é”™è¯¯å¤„ç†
try {
    $result = $this->licenseService->createOrder(...);
} catch (\Exception $e) {
    return response()->json([
        'success' => false,
        'message' => 'è®¢å•åˆ›å»ºå¤±è´¥ï¼š' . $e->getMessage()
    ], 500);
}
```

## ğŸ¯ æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] æ’ä»¶åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] å…è´¹æ’ä»¶å¯ä»¥ç›´æ¥å®‰è£…
- [ ] ä»˜è´¹æ’ä»¶è´­ä¹°æµç¨‹å®Œæ•´
- [ ] TokenPayæ”¯ä»˜æ­£å¸¸
- [ ] æˆæƒç æ¿€æ´»æˆåŠŸ
- [ ] åŸŸåç»‘å®šæ­£ç¡®
- [ ] æ’ä»¶å¯ç”¨/ç¦ç”¨æ­£å¸¸
- [ ] æ’ä»¶å¸è½½å¹²å‡€

### å®‰å…¨æµ‹è¯•
- [ ] åˆ é™¤æ ¸å¿ƒæ–‡ä»¶åç³»ç»Ÿé”å®š
- [ ] ä¿®æ”¹æ ¸å¿ƒæ–‡ä»¶åç³»ç»Ÿé”å®š
- [ ] å‰ç«¯æ— æ³•çœ‹åˆ°æˆæƒç³»ç»ŸAPIåœ°å€
- [ ] æˆæƒç éªŒè¯æ­£ç¡®
- [ ] åŸŸåéªŒè¯æ­£ç¡®
- [ ] ä¸€ä¸ªæˆæƒç åªèƒ½ç»‘å®šä¸€ä¸ªåŸŸå

### æ€§èƒ½æµ‹è¯•
- [ ] æ’ä»¶åˆ—è¡¨åŠ è½½é€Ÿåº¦ < 2ç§’
- [ ] æ’ä»¶ä¸‹è½½é€Ÿåº¦æ­£å¸¸
- [ ] æ’ä»¶å®‰è£…é€Ÿåº¦ < 10ç§’

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.2  
**åˆ›å»ºæ—¶é—´**ï¼š2025-12-07  
**æœ€åæ›´æ–°**ï¼š2025-12-08 22:00  
**çŠ¶æ€**ï¼šæƒé™æ§åˆ¶å’Œæ’ä»¶åŒæ­¥åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### ä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰

```powershell
# PowerShell - åªä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶
scp -i C:\Users\Administrator\.ssh\id_rsa -P 1991 H:\codedujiao\dujiaoka-master\app\Admin\Controllers\PluginController.php root@103.121.92.216:/opt/1panel/www/sites/ka.riyu.cc/index/app/Admin/Controllers/

# é‡å¯ PHP å®¹å™¨
ssh -i C:\Users\Administrator\.ssh\id_rsa -p 1991 root@103.121.92.216 "docker restart php74"
```

### æ¸…ç†æ—§æ’ä»¶æ•°æ®

```sql
-- SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh -i C:\Users\Administrator\.ssh\id_rsa -p 1991 root@103.121.92.216

-- è¿›å…¥ MySQL
docker exec -it mysql mysql -u dujiaokashu -p
-- å¯†ç ï¼šHANwanlong520

USE dujiaokashu;

-- æ¸…ç©ºæ‰€æœ‰æ’ä»¶æ•°æ®
TRUNCATE TABLE plugins;
TRUNCATE TABLE installed_plugins;

EXIT;
```

### åŒæ­¥æ’ä»¶åˆ—è¡¨

1. è®¿é—®ï¼šhttps://ka.riyu.cc/admin/plugins
2. ç‚¹å‡»"åŒæ­¥æ’ä»¶åˆ—è¡¨"æŒ‰é’®
3. ç¡®è®¤æ’ä»¶æ ‡è¯†ä½¿ç”¨ unique_codeï¼ˆå¦‚ ce001ï¼‰

## ğŸ“ æ”¯ä»˜æ’ä»¶åŒ–æ”¹é€ è®¡åˆ’

### æ”¹é€ ç›®æ ‡

å°†ç‹¬è§’å¡æ•°ç°æœ‰çš„ 12 ä¸ªæ”¯ä»˜æ–¹å¼å…¨éƒ¨æ”¹é€ ä¸ºæ’ä»¶ï¼Œç”¨æˆ·å¯ä»¥æŒ‰éœ€å®‰è£…ã€‚

### ç°æœ‰æ”¯ä»˜æ–¹å¼æ¸…å•

| åºå· | æ”¯ä»˜æ–¹å¼ | ç±»å‹ | æ’ä»¶æ ‡è¯† | å»ºè®®å®šä»· | ä¼˜å…ˆçº§ |
|------|---------|------|---------|---------|--------|
| 1 | æ”¯ä»˜å® (Alipay) | å›½å†…ä¸»æµ | alipay-payment | å…è´¹ | â­â­â­â­â­ |
| 2 | å¾®ä¿¡æ”¯ä»˜ (Wepay) | å›½å†…ä¸»æµ | wechat-payment | å…è´¹ | â­â­â­â­â­ |
| 3 | TokenPay | åŠ å¯†è´§å¸ | tokenpay-payment | å…è´¹ | â­â­â­â­ |
| 4 | EPUSDT | åŠ å¯†è´§å¸ | epusdt-payment | Â¥99 | â­â­â­â­ |
| 5 | PayPal | å›½é™…æ”¯ä»˜ | paypal-payment | å…è´¹ | â­â­â­â­ |
| 6 | Stripe | å›½é™…æ”¯ä»˜ | stripe-payment | å…è´¹ | â­â­â­â­ |
| 7 | Coinbase | åŠ å¯†è´§å¸ | coinbase-payment | Â¥199 | â­â­â­ |
| 8 | æ˜“æ”¯ä»˜ (Yipay) | ç¬¬ä¸‰æ–¹ | yipay-payment | å…è´¹ | â­â­â­ |
| 9 | Payjs | ç¬¬ä¸‰æ–¹ | payjs-payment | å…è´¹ | â­â­â­ |
| 10 | ç æ”¯ä»˜ (Mapay) | ç¬¬ä¸‰æ–¹ | mapay-payment | å…è´¹ | â­â­ |
| 11 | Vå…ç­¾ (Vpay) | ç¬¬ä¸‰æ–¹ | vpay-payment | å…è´¹ | â­â­ |
| 12 | Paysapi | ç¬¬ä¸‰æ–¹ | paysapi-payment | å…è´¹ | â­â­ |

**å®šä»·ç­–ç•¥**ï¼š
- **å…è´¹**ï¼šä¸»æµæ”¯ä»˜æ–¹å¼ï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡ã€PayPalã€Stripeï¼‰+ å¸¸ç”¨ç¬¬ä¸‰æ–¹
- **ä»˜è´¹**ï¼šåŠ å¯†è´§å¸æ”¯ä»˜ï¼ˆEPUSDT Â¥99ã€Coinbase Â¥199ï¼‰

### æ’ä»¶åŒ–æ”¹é€ æ–¹æ¡ˆ

#### 1. æ ‡å‡†æ’ä»¶ç»“æ„
```
public/plugins/{payment-name}/
â”œâ”€â”€ plugin.json              # æ’ä»¶é…ç½®
â”œâ”€â”€ install.php             # å®‰è£…è„šæœ¬ï¼ˆæ’å…¥ pays è¡¨ï¼‰
â”œâ”€â”€ uninstall.php          # å¸è½½è„šæœ¬ï¼ˆåˆ é™¤ pays è¡¨è®°å½•ï¼‰
â”œâ”€â”€ routes.php             # è·¯ç”±å®šä¹‰
â”œâ”€â”€ README.md              # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ {PaymentName}Controller.php  # æ”¯ä»˜æ§åˆ¶å™¨
â””â”€â”€ config.php             # é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```

#### 2. plugin.json æ¨¡æ¿
```json
{
  "name": "æ”¯ä»˜å®æ”¯ä»˜",
  "slug": "alipay-payment",
  "version": "1.0.0",
  "description": "æ”¯æŒæ”¯ä»˜å®æ‰«ç æ”¯ä»˜å’Œæ‰‹æœºç½‘ç«™æ”¯ä»˜",
  "author": "ç‹¬è§’å¡æ•°",
  "requires": "1.0.0",
  "type": "payment",
  "icon": "alipay",
  "is_free": true,
  "settings": {
    "app_id": {
      "label": "åº”ç”¨ID (App ID)",
      "type": "text",
      "required": true
    },
    "ali_public_key": {
      "label": "æ”¯ä»˜å®å…¬é’¥",
      "type": "textarea",
      "required": true
    },
    "private_key": {
      "label": "åº”ç”¨ç§é’¥",
      "type": "textarea",
      "required": true
    }
  }
}
```

#### 3. install.php æ¨¡æ¿
```php
<?php
return function() {
    try {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        $exists = DB::table('pays')
            ->where('pay_check', 'alipay')
            ->exists();
        
        if (!$exists) {
            DB::table('pays')->insert([
                'pay_name' => 'æ”¯ä»˜å®',
                'pay_check' => 'alipay',
                'pay_method' => 2, // 1=è·³è½¬, 2=æ‰«ç 
                'pay_handleroute' => 'pay/alipay',
                'merchant_id' => '',
                'merchant_key' => '',
                'merchant_pem' => '',
                'is_open' => 0,
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }
        
        return [
            'success' => true,
            'message' => 'æ”¯ä»˜å®æ”¯ä»˜æ’ä»¶å®‰è£…æˆåŠŸï¼'
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => 'å®‰è£…å¤±è´¥ï¼š' . $e->getMessage()
        ];
    }
};
```

#### 4. æ”¹é€ æ­¥éª¤ï¼ˆç¨³å¦¥æ–¹æ¡ˆï¼‰

**ğŸ¯ æ ¸å¿ƒæ€è·¯**ï¼šå…ˆç§»é™¤ â†’ æµ‹è¯•æ’ä»¶å¸‚åœº â†’ åŠ å¯†éƒ¨ç½² â†’ å†å¼€å‘æ”¯ä»˜æ’ä»¶

---

### ç¬¬ä¸€é˜¶æ®µï¼šç§»é™¤ç°æœ‰æ”¯ä»˜åŠŸèƒ½ï¼ˆ0.5å¤©ï¼‰

**ç›®æ ‡**ï¼šå°†ç‹¬è§’å¡æ•°æ”¹é€ ä¸º"çº¯å‡€ç‰ˆ"ï¼Œæ‰€æœ‰æ”¯ä»˜åŠŸèƒ½é€šè¿‡æ’ä»¶æä¾›

#### 1.1 å¤‡ä»½ç°æœ‰ä»£ç 
```powershell
# åˆ›å»ºå¤‡ä»½åˆ†æ”¯
git checkout -b backup-before-plugin-market
git add .
git commit -m "backup: æ’ä»¶å¸‚åœºæ”¹é€ å‰çš„å®Œæ•´å¤‡ä»½"
git push origin backup-before-plugin-market
```

#### 1.2 ç§»é™¤æ”¯ä»˜æ§åˆ¶å™¨
```powershell
# ç§»åŠ¨åˆ°å¤‡ä»½ç›®å½•ï¼ˆä¸åˆ é™¤ï¼Œä¿ç•™ç”¨äºåˆ¶ä½œæ’ä»¶ï¼‰
mkdir -p backup/payment-controllers
mv app/Http/Controllers/Pay/*.php backup/payment-controllers/
```

**ä¿ç•™æ–‡ä»¶**ï¼š
- `app/Http/Controllers/Pay/PayController.php` - åŸºç±»ä¿ç•™

**ç§»é™¤æ–‡ä»¶**ï¼ˆ12ä¸ªï¼‰ï¼š
- AlipayController.php
- WepayController.php
- TokenPayController.php
- EpusdtController.php
- PaypalPayController.php
- StripeController.php
- CoinbaseController.php
- YipayController.php
- PayjsController.php
- MapayController.php
- VpayController.php
- PaysapiController.php

#### 1.3 æ¸…ç†æ”¯ä»˜è·¯ç”±
```php
// routes/web.php
// æ³¨é‡Šæ‰æ‰€æœ‰æ”¯ä»˜è·¯ç”±ï¼Œæ”¹ä¸ºåŠ¨æ€åŠ è½½
/*
Route::any('/pay/alipay/{...}', ...);
Route::any('/pay/wepay/{...}', ...);
...
*/

// æ·»åŠ åŠ¨æ€è·¯ç”±åŠ è½½
Route::group(['middleware' => ['dujiaoka.boot']], function () {
    // åŠ¨æ€åŠ è½½å·²å®‰è£…æ”¯ä»˜æ’ä»¶çš„è·¯ç”±
    $installedPlugins = \App\Models\InstalledPlugin::where('status', 'active')->get();
    foreach ($installedPlugins as $plugin) {
        $routeFile = public_path("plugins/{$plugin->plugin_slug}/routes.php");
        if (file_exists($routeFile)) {
            require $routeFile;
        }
    }
});
```

#### 1.4 ä¿®æ”¹æ”¯ä»˜é€‰æ‹©é€»è¾‘
```php
// app/Http/Controllers/OrderController.php
// ä¿®æ”¹è·å–æ”¯ä»˜æ–¹å¼çš„é€»è¾‘

// åŸä»£ç ï¼š
$pays = Pay::where('is_open', 1)->get();

// æ–°ä»£ç ï¼š
$installedPayments = \App\Models\InstalledPlugin::where('status', 'active')
    ->whereHas('plugin', function($q) {
        $q->where('type', 'payment');
    })
    ->pluck('plugin_slug')
    ->toArray();

$pays = Pay::where('is_open', 1)
    ->whereIn('pay_check', $installedPayments)
    ->get();
```

#### 1.5 æ¸…ç©º pays è¡¨ï¼ˆå¯é€‰ï¼‰
```sql
-- å¤‡ä»½ç°æœ‰æ”¯ä»˜é…ç½®
CREATE TABLE pays_backup AS SELECT * FROM pays;

-- æ¸…ç©ºæ”¯ä»˜æ–¹å¼ï¼ˆç”¨æˆ·éœ€è¦é‡æ–°å®‰è£…æ’ä»¶ï¼‰
TRUNCATE TABLE pays;
```

---

### ç¬¬äºŒé˜¶æ®µï¼šæµ‹è¯•æ’ä»¶å¸‚åœºï¼ˆ1å¤©ï¼‰

**ç›®æ ‡**ï¼šç¡®ä¿æ’ä»¶å¸‚åœºæ ¸å¿ƒåŠŸèƒ½å®Œå…¨å¯ç”¨

#### 2.1 åŠŸèƒ½æµ‹è¯•æ¸…å•
- [x] åå°æ’ä»¶åˆ—è¡¨æ˜¾ç¤º âœ…
- [x] åŒæ­¥æ’ä»¶åˆ—è¡¨ âœ…
- [x] è´­ä¹°æ’ä»¶æµç¨‹ âœ…
- [x] æ¿€æ´»æ’ä»¶æµç¨‹ âœ…
- [ ] å®‰è£…å…è´¹æ’ä»¶ï¼ˆTokenPayï¼‰
- [ ] å®‰è£…ä»˜è´¹æ’ä»¶ï¼ˆæµ‹è¯•å®Œæ•´æµç¨‹ï¼‰
- [ ] å¯ç”¨/ç¦ç”¨æ’ä»¶
- [ ] å¸è½½æ’ä»¶
- [ ] æ’ä»¶æƒé™éªŒè¯

#### 2.2 è¾¹ç•Œæµ‹è¯•
- [ ] æ— æˆæƒç å®‰è£…ä»˜è´¹æ’ä»¶ â†’ åº”è¯¥å¤±è´¥
- [ ] é”™è¯¯æˆæƒç æ¿€æ´» â†’ åº”è¯¥å¤±è´¥
- [ ] æˆæƒç è¿‡æœŸ â†’ åº”è¯¥æç¤º
- [ ] é‡å¤å®‰è£…æ’ä»¶ â†’ åº”è¯¥æç¤º
- [ ] å¸è½½åé‡æ–°å®‰è£… â†’ åº”è¯¥æˆåŠŸ

#### 2.3 æ€§èƒ½æµ‹è¯•
- [ ] æ’ä»¶åˆ—è¡¨åŠ è½½é€Ÿåº¦
- [ ] æ’ä»¶ä¸‹è½½é€Ÿåº¦
- [ ] æ’ä»¶å®‰è£…é€Ÿåº¦
- [ ] å¹¶å‘å®‰è£…æµ‹è¯•

---

### ç¬¬ä¸‰é˜¶æ®µï¼šåŠ å¯†æ ¸å¿ƒä»£ç ï¼ˆ0.5å¤©ï¼‰

**ç›®æ ‡**ï¼šä¿æŠ¤æ’ä»¶å¸‚åœºæ ¸å¿ƒä»£ç ï¼Œé˜²æ­¢ç ´è§£

#### 3.1 éœ€è¦åŠ å¯†çš„æ–‡ä»¶
```
æ ¸å¿ƒæ–‡ä»¶ï¼ˆå¿…é¡»åŠ å¯†ï¼‰ï¼š
- app/Http/Middleware/PluginMarketGuard.php
- app/Service/PluginLicenseService.php
- app/Service/PluginInstallService.php
- app/Admin/Controllers/PluginController.php
- app/Http/Controllers/PluginMarketController.php

æ¨¡å‹æ–‡ä»¶ï¼ˆå»ºè®®åŠ å¯†ï¼‰ï¼š
- app/Models/Plugin.php
- app/Models/InstalledPlugin.php
```

#### 3.2 åŠ å¯†å·¥å…·é€‰æ‹©
**æ¨è**ï¼šionCube Encoderï¼ˆPHP 7.4 å…¼å®¹ï¼‰

**åŠ å¯†å‘½ä»¤**ï¼š
```bash
# å®‰è£… ionCube Encoder
# ä¸‹è½½ï¼šhttps://www.ioncube.com/encoder.php

# åŠ å¯†å•ä¸ªæ–‡ä»¶
ioncube_encoder.sh \
  --encode app/Http/Middleware/PluginMarketGuard.php \
  --into encrypted/

# æ‰¹é‡åŠ å¯†
ioncube_encoder.sh \
  --encode app/Service/*.php \
  --into encrypted/
```

#### 3.3 åŠ å¯†åæµ‹è¯•
- [ ] æ’ä»¶å¸‚åœºåŠŸèƒ½æ­£å¸¸
- [ ] åŠ å¯†æ–‡ä»¶å¯ä»¥æ­£å¸¸è¿è¡Œ
- [ ] é”™è¯¯æç¤ºæ­£å¸¸æ˜¾ç¤º
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

---

### ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆ0.5å¤©ï¼‰

**ç›®æ ‡**ï¼šå°†"çº¯å‡€ç‰ˆ"ç‹¬è§’å¡æ•°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

#### 4.1 éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] åŠ å¯†æ–‡ä»¶æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡å¥½

#### 4.2 éƒ¨ç½²æ­¥éª¤
```powershell
# 1. æ‰“åŒ…é¡¹ç›®ï¼ˆåŒ…å«åŠ å¯†æ–‡ä»¶ï¼‰
cd H:\codedujiao\dujiaoka-master
Compress-Archive -Path * -DestinationPath ..\dujiaoka-plugin-market-v2.zip -Force

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i C:\Users\Administrator\.ssh\id_rsa -P 1991 H:\codedujiao\dujiaoka-plugin-market-v2.zip root@103.121.92.216:/opt/1panel/www/sites/ka.riyu.cc/

# 3. æœåŠ¡å™¨éƒ¨ç½²
ssh -i C:\Users\Administrator\.ssh\id_rsa -p 1991 root@103.121.92.216 "
cd /opt/1panel/www/sites/ka.riyu.cc/ && \
unzip -o dujiaoka-plugin-market-v2.zip -d index/ && \
cd index/ && \
chmod -R 777 storage bootstrap/cache public/plugins && \
docker restart php74
"
```

#### 4.3 éƒ¨ç½²åéªŒè¯
- [ ] ç½‘ç«™å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] åå°å¯ä»¥ç™»å½•
- [ ] æ’ä»¶å¸‚åœºå¯ä»¥æ‰“å¼€
- [ ] åŒæ­¥æ’ä»¶åˆ—è¡¨æ­£å¸¸
- [ ] è´­ä¹°æµç¨‹æ­£å¸¸

#### 4.4 å›æ»šæ–¹æ¡ˆ
```bash
# å¦‚æœå‡ºç°é—®é¢˜ï¼Œç«‹å³å›æ»š
cd /opt/1panel/www/sites/ka.riyu.cc/
rm -rf index/
unzip -o dujiaoka-backup.zip -d index/
docker restart php74
```

---

### ç¬¬äº”é˜¶æ®µï¼šå¼€å‘æ”¯ä»˜æ’ä»¶ï¼ˆ3-4å¤©ï¼‰

**ç›®æ ‡**ï¼šå°† 12 ä¸ªæ”¯ä»˜æ–¹å¼æ”¹é€ ä¸ºæ’ä»¶

#### 5.1 ä¼˜å…ˆçº§æ’åº

**ç¬¬ä¸€æ‰¹ï¼ˆå¿…è£…ï¼Œå…è´¹ï¼‰**ï¼š
1. [ ] æ”¯ä»˜å®æ”¯ä»˜ï¼ˆalipay-paymentï¼‰
2. [ ] å¾®ä¿¡æ”¯ä»˜ï¼ˆwechat-paymentï¼‰
3. [ ] TokenPayï¼ˆtokenpay-paymentï¼‰- å·²æœ‰æ¨¡æ¿ âœ…

**ç¬¬äºŒæ‰¹ï¼ˆæ¨èï¼‰**ï¼š
4. [ ] EPUSDTï¼ˆepusdt-paymentï¼‰- Â¥99
5. [ ] PayPalï¼ˆpaypal-paymentï¼‰- å…è´¹
6. [ ] Stripeï¼ˆstripe-paymentï¼‰- å…è´¹

**ç¬¬ä¸‰æ‰¹ï¼ˆå¸¸ç”¨ï¼‰**ï¼š
7. [ ] æ˜“æ”¯ä»˜ï¼ˆyipay-paymentï¼‰- å…è´¹
8. [ ] Payjsï¼ˆpayjs-paymentï¼‰- å…è´¹

**ç¬¬å››æ‰¹ï¼ˆå¯é€‰ï¼‰**ï¼š
9. [ ] Coinbaseï¼ˆcoinbase-paymentï¼‰- Â¥199
10. [ ] ç æ”¯ä»˜ï¼ˆmapay-paymentï¼‰- å…è´¹
11. [ ] Vå…ç­¾ï¼ˆvpay-paymentï¼‰- å…è´¹
12. [ ] Paysapiï¼ˆpaysapi-paymentï¼‰- å…è´¹

#### 5.2 å¼€å‘æµç¨‹ï¼ˆæ¯ä¸ªæ’ä»¶ï¼‰
1. å¤åˆ¶ TokenPay æ’ä»¶æ¨¡æ¿
2. ä¿®æ”¹ plugin.jsonï¼ˆåç§°ã€é…ç½®é¡¹ï¼‰
3. å¤åˆ¶åŸæ”¯ä»˜æ§åˆ¶å™¨ä»£ç 
4. ä¿®æ”¹å‘½åç©ºé—´å’Œç±»å
5. ç¼–å†™ install.phpï¼ˆæ’å…¥ pays è¡¨ï¼‰
6. ç¼–å†™ uninstall.phpï¼ˆåˆ é™¤ pays è¡¨è®°å½•ï¼‰
7. æµ‹è¯•å®‰è£…ã€æ”¯ä»˜ã€å¸è½½æµç¨‹
8. æ‰“åŒ… zip æ–‡ä»¶
9. ä¸Šä¼ åˆ°æˆæƒç³»ç»Ÿ
10. é…ç½®ä¸‹è½½åœ°å€

#### 5.3 æ‰¹é‡åˆ¶ä½œå·¥å…·ï¼ˆå¯é€‰ï¼‰
```php
// åˆ›å»ºä¸€ä¸ªè„šæœ¬è‡ªåŠ¨ç”Ÿæˆæ’ä»¶
php artisan make:payment-plugin alipay-payment "æ”¯ä»˜å®æ”¯ä»˜"
```

---

### ç¬¬å…­é˜¶æ®µï¼šä¸Šæ¶æ’ä»¶å¸‚åœºï¼ˆ1å¤©ï¼‰

**ç›®æ ‡**ï¼šå°†æ‰€æœ‰æ”¯ä»˜æ’ä»¶ä¸Šæ¶åˆ°æˆæƒç³»ç»Ÿ

#### 6.1 å‡†å¤‡æ’ä»¶åŒ…
```bash
# æ¯ä¸ªæ’ä»¶æ‰“åŒ…
cd public/plugins/alipay-payment
zip -r ../../../alipay-payment-v1.0.0.zip .

# æ‰¹é‡æ‰“åŒ…
for dir in public/plugins/*/; do
    name=$(basename "$dir")
    cd "$dir"
    zip -r "../../../${name}-v1.0.0.zip" .
    cd -
done
```

#### 6.2 ä¸Šä¼ åˆ°æˆæƒç³»ç»Ÿ
```python
# åœ¨æˆæƒç³»ç»Ÿä¸­æ·»åŠ åŠŸèƒ½
features = [
    {"name": "æ”¯ä»˜å®æ”¯ä»˜", "unique_code": "alipay-payment", "price": 0, "version": "1.0.0"},
    {"name": "å¾®ä¿¡æ”¯ä»˜", "unique_code": "wechat-payment", "price": 0, "version": "1.0.0"},
    {"name": "TokenPay", "unique_code": "tokenpay-payment", "price": 0, "version": "1.0.0"},
    {"name": "EPUSDT", "unique_code": "epusdt-payment", "price": 99, "version": "1.0.0"},
    # ... å…¶ä»–æ’ä»¶
]
```

#### 6.3 é…ç½®ä¸‹è½½åœ°å€
```python
# æ¯ä¸ªåŠŸèƒ½é…ç½®ä¸‹è½½åœ°å€
feature.download_url = "https://cdn.example.com/plugins/alipay-payment-v1.0.0.zip"
```

#### 6.4 æµ‹è¯•å®Œæ•´æµç¨‹
- [ ] ç‹¬è§’å¡æ•°åå°åŒæ­¥æ’ä»¶åˆ—è¡¨
- [ ] æ˜¾ç¤ºæ‰€æœ‰ 12 ä¸ªæ”¯ä»˜æ’ä»¶
- [ ] å…è´¹æ’ä»¶ç›´æ¥å®‰è£…
- [ ] ä»˜è´¹æ’ä»¶è´­ä¹° â†’ æ¿€æ´» â†’ å®‰è£…
- [ ] å®‰è£…åæ”¯ä»˜æ–¹å¼å¯ç”¨
- [ ] æ”¯ä»˜æµç¨‹æ­£å¸¸
- [ ] å¸è½½åæ”¯ä»˜æ–¹å¼æ¶ˆå¤±

---

### æ€»æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| 1 | ç§»é™¤ç°æœ‰æ”¯ä»˜åŠŸèƒ½ | 0.5å¤© |
| 2 | æµ‹è¯•æ’ä»¶å¸‚åœº | 1å¤© |
| 3 | åŠ å¯†æ ¸å¿ƒä»£ç  | 0.5å¤© |
| 4 | éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ | 0.5å¤© |
| 5 | å¼€å‘æ”¯ä»˜æ’ä»¶ï¼ˆ12ä¸ªï¼‰ | 3-4å¤© |
| 6 | ä¸Šæ¶æ’ä»¶å¸‚åœº | 1å¤© |
| **æ€»è®¡** | | **6.5-7.5å¤©** |

---

### é£é™©æ§åˆ¶

#### 1. æŠ€æœ¯é£é™©
- âŒ ç§»é™¤æ”¯ä»˜åŠŸèƒ½åç½‘ç«™æ— æ³•ä½¿ç”¨ â†’ âœ… ä¿ç•™ TokenPay ä½œä¸ºé»˜è®¤æ”¯ä»˜
- âŒ åŠ å¯†åä»£ç æ— æ³•è¿è¡Œ â†’ âœ… æœ¬åœ°å……åˆ†æµ‹è¯•
- âŒ æ’ä»¶å®‰è£…å¤±è´¥ â†’ âœ… è¯¦ç»†é”™è¯¯æ—¥å¿— + å›æ»šæœºåˆ¶

#### 2. ä¸šåŠ¡é£é™©
- âŒ ç”¨æˆ·æ— æ³•æ”¯ä»˜ â†’ âœ… æå‰é€šçŸ¥ç”¨æˆ·å‡çº§
- âŒ ç°æœ‰è®¢å•å—å½±å“ â†’ âœ… æ•°æ®åº“å¤‡ä»½ + å…¼å®¹å¤„ç†
- âŒ é…ç½®ä¸¢å¤± â†’ âœ… è‡ªåŠ¨è¿ç§»å·¥å…·

#### 3. å›æ»šæ–¹æ¡ˆ
```bash
# ä»»ä½•é˜¶æ®µå‡ºç°é—®é¢˜ï¼Œç«‹å³å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
git checkout backup-before-plugin-market
# é‡æ–°éƒ¨ç½²
```

---

### æˆåŠŸæ ‡å‡†

#### é˜¶æ®µ 1-4ï¼ˆæ’ä»¶å¸‚åœºä¸Šçº¿ï¼‰
- âœ… ç½‘ç«™æ­£å¸¸è¿è¡Œ
- âœ… æ’ä»¶å¸‚åœºåŠŸèƒ½å®Œæ•´
- âœ… è‡³å°‘ 1 ä¸ªæ”¯ä»˜æ’ä»¶å¯ç”¨ï¼ˆTokenPayï¼‰
- âœ… æ ¸å¿ƒä»£ç å·²åŠ å¯†

#### é˜¶æ®µ 5-6ï¼ˆæ”¯ä»˜æ’ä»¶å®Œæˆï¼‰
- âœ… 12 ä¸ªæ”¯ä»˜æ’ä»¶å…¨éƒ¨å¯ç”¨
- âœ… å…è´¹æ’ä»¶å¯ä»¥ç›´æ¥å®‰è£…
- âœ… ä»˜è´¹æ’ä»¶è´­ä¹°æµç¨‹æ­£å¸¸
- âœ… æ”¯ä»˜æµç¨‹å®Œå…¨æ­£å¸¸

---

**æ€»é¢„è®¡æ—¶é—´**ï¼š6.5-7.5 å¤©

### æ”¹é€ ä¼˜åŠ¿

#### 1. ç”¨æˆ·ä½“éªŒ
- âœ… æŒ‰éœ€å®‰è£…ï¼Œå‡å°‘é…ç½®å¤æ‚åº¦
- âœ… ç•Œé¢æ›´ç®€æ´ï¼ˆåªæ˜¾ç¤ºå·²å®‰è£…çš„æ”¯ä»˜æ–¹å¼ï¼‰
- âœ… é™ä½å­¦ä¹ æˆæœ¬

#### 2. å¼€å‘ç»´æŠ¤
- âœ… ä»£ç è§£è€¦ï¼Œæ˜“äºç»´æŠ¤
- âœ… ç‹¬ç«‹æ›´æ–°ï¼Œä¸å½±å“å…¶ä»–æ”¯ä»˜æ–¹å¼
- âœ… ç¬¬ä¸‰æ–¹å¼€å‘è€…å¯ä»¥è´¡çŒ®æ–°æ’ä»¶

#### 3. å•†ä¸šä»·å€¼
- âœ… éƒ¨åˆ†æ’ä»¶æ”¶è´¹ï¼ˆåŠ å¯†è´§å¸æ”¯ä»˜ï¼‰
- âœ… ä¼ä¸šå®šåˆ¶æ’ä»¶
- âœ… æ’ä»¶å¸‚åœºç”Ÿæ€

### æŠ€æœ¯è¦ç‚¹

#### 1. åŠ¨æ€è·¯ç”±åŠ è½½
```php
// åœ¨ RouteServiceProvider ä¸­
foreach (InstalledPlugin::where('type', 'payment')->get() as $plugin) {
    $routeFile = public_path("plugins/{$plugin->slug}/routes.php");
    if (file_exists($routeFile)) {
        require $routeFile;
    }
}
```

#### 2. æ”¯ä»˜æ–¹å¼è¿‡æ»¤
```php
// åªæ˜¾ç¤ºå·²å®‰è£…æ’ä»¶å¯¹åº”çš„æ”¯ä»˜æ–¹å¼
$installedPayments = InstalledPlugin::where('type', 'payment')
    ->pluck('slug')
    ->toArray();

$pays = Pay::where('is_open', 1)
    ->whereIn('pay_check', $installedPayments)
    ->get();
```

#### 3. æ’ä»¶é’©å­
```php
// æ”¯ä»˜æˆåŠŸåè§¦å‘æ’ä»¶é’©å­
event(new PaymentSuccess($order, $paymentPlugin));

// æ’ä»¶å¯ä»¥ç›‘å¬äº‹ä»¶åšé¢å¤–å¤„ç†
class PaymentSuccessListener
{
    public function handle(PaymentSuccess $event)
    {
        // è‡ªå®šä¹‰é€»è¾‘
    }
}
```

### å…¼å®¹æ€§å¤„ç†

#### 1. å‘åå…¼å®¹
- ä¿ç•™åŸæœ‰æ”¯ä»˜æ§åˆ¶å™¨ï¼ˆæ ‡è®°ä¸º deprecatedï¼‰
- æä¾›è¿ç§»å·¥å…·ï¼ˆä¸€é”®è½¬æ¢ä¸ºæ’ä»¶ï¼‰
- æ–‡æ¡£è¯´æ˜å‡çº§æ­¥éª¤

#### 2. æ•°æ®è¿ç§»
```php
// å°†ç°æœ‰ pays è¡¨æ•°æ®å…³è”åˆ°æ’ä»¶
foreach (Pay::all() as $pay) {
    $pluginSlug = $this->getPluginSlug($pay->pay_check);
    
    // è‡ªåŠ¨å®‰è£…å¯¹åº”æ’ä»¶
    $this->installPlugin($pluginSlug);
}
```

### æ”¹é€ é£é™©

#### 1. æŠ€æœ¯é£é™©
- âŒ è·¯ç”±å†²çªï¼ˆè§£å†³ï¼šå‘½åç©ºé—´éš”ç¦»ï¼‰
- âŒ ä¾èµ–å†²çªï¼ˆè§£å†³ï¼šComposer éš”ç¦»ï¼‰
- âŒ æ€§èƒ½ä¸‹é™ï¼ˆè§£å†³ï¼šè·¯ç”±ç¼“å­˜ï¼‰

#### 2. ç”¨æˆ·é£é™©
- âŒ å‡çº§åæ”¯ä»˜å¤±æ•ˆï¼ˆè§£å†³ï¼šè‡ªåŠ¨è¿ç§» + å›æ»šæœºåˆ¶ï¼‰
- âŒ é…ç½®ä¸¢å¤±ï¼ˆè§£å†³ï¼šæ•°æ®å¤‡ä»½ï¼‰

### æµ‹è¯•æ¸…å•

#### åŠŸèƒ½æµ‹è¯•
- [ ] æ’ä»¶å®‰è£…ï¼ˆ12ä¸ªæ”¯ä»˜æ–¹å¼ï¼‰
- [ ] æ’ä»¶å¸è½½
- [ ] æ”¯ä»˜æµç¨‹ï¼ˆæ¯ä¸ªæ”¯ä»˜æ–¹å¼ï¼‰
- [ ] æ”¯ä»˜å›è°ƒ
- [ ] è®¢å•çŠ¶æ€æ›´æ–°

#### å…¼å®¹æ€§æµ‹è¯•
- [ ] æ—§ç‰ˆæœ¬å‡çº§
- [ ] æ•°æ®è¿ç§»
- [ ] é…ç½®è¿ç§»

#### æ€§èƒ½æµ‹è¯•
- [ ] è·¯ç”±åŠ è½½æ—¶é—´
- [ ] æ”¯ä»˜å“åº”æ—¶é—´
- [ ] å¹¶å‘æ”¯ä»˜

---

## ğŸ“ ç¬¬ä¸€ä¸ªæ’ä»¶ï¼šä¼šå‘˜ç³»ç»Ÿ

### æ’ä»¶æ¦‚è¿°

**æ’ä»¶åç§°**ï¼šä¼šå‘˜ç³»ç»Ÿï¼ˆMember Systemï¼‰  
**æ’ä»¶æ ‡è¯†**ï¼šmember-system  
**ç‰ˆæœ¬**ï¼š1.0.0  
**ç±»å‹**ï¼šä»˜è´¹æ’ä»¶  
**ä»·æ ¼**ï¼šÂ¥299  
**ä½œè€…**ï¼šç‹¼å“¥

### æ ¸å¿ƒåŠŸèƒ½

#### 1. ä¼šå‘˜ç­‰çº§ç³»ç»Ÿ
- **æ™®é€šä¼šå‘˜**ï¼ˆå…è´¹ï¼‰
  - æ­£å¸¸è´­ä¹°å•†å“
  - æ— æŠ˜æ‰£
  
- **VIPä¼šå‘˜**ï¼ˆæœˆè´¹ Â¥29ï¼‰
  - å…¨åœºå•†å“ 9.5 æŠ˜
  - ä¸“å±å®¢æœ
  - ä¼˜å…ˆå‘è´§
  
- **SVIPä¼šå‘˜**ï¼ˆæœˆè´¹ Â¥99ï¼‰
  - å…¨åœºå•†å“ 9 æŠ˜
  - ä¸“å±å®¢æœ
  - ä¼˜å…ˆå‘è´§
  - å…è¿è´¹ï¼ˆå¦‚æœ‰ï¼‰
  - ç”Ÿæ—¥ç¤¼åŒ…

#### 2. ä¼šå‘˜è´­ä¹°æµç¨‹
```
ç”¨æˆ·ä¸‹å• â†’ é€‰æ‹©ä¼šå‘˜å¥—é¤ â†’ æ”¯ä»˜ â†’ è‡ªåŠ¨å¼€é€š â†’ äº«å—æƒç›Š
```

#### 3. ä¼šå‘˜æƒç›Š
- **æŠ˜æ‰£ä¼˜æƒ **ï¼šè´­ä¹°å•†å“æ—¶è‡ªåŠ¨åº”ç”¨ä¼šå‘˜æŠ˜æ‰£
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šæ¶ˆè´¹è·å¾—ç§¯åˆ†ï¼Œç§¯åˆ†å¯æŠµæ‰£ï¼ˆæœªæ¥æ‰©å±•ï¼‰
- **ä¸“å±å•†å“**ï¼šæŸäº›å•†å“åªå¯¹ä¼šå‘˜å¼€æ”¾
- **ä¼˜å…ˆæœåŠ¡**ï¼šä¼šå‘˜è®¢å•ä¼˜å…ˆå¤„ç†

#### 4. ä¼šå‘˜ç®¡ç†ï¼ˆåå°ï¼‰
- ä¼šå‘˜åˆ—è¡¨ï¼ˆæŸ¥çœ‹æ‰€æœ‰ä¼šå‘˜ï¼‰
- ä¼šå‘˜ç­‰çº§ç®¡ç†ï¼ˆæ·»åŠ /ç¼–è¾‘ç­‰çº§ï¼‰
- ä¼šå‘˜è®¢å•ç»Ÿè®¡
- ä¼šå‘˜åˆ°æœŸæé†’
- æ‰‹åŠ¨å¼€é€š/ç»­è´¹ä¼šå‘˜

### æ•°æ®åº“è®¾è®¡

#### 1. ä¼šå‘˜ç­‰çº§è¡¨ï¼ˆmember_levelsï¼‰
```sql
CREATE TABLE `member_levels` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT 'ç­‰çº§åç§°',
  `slug` varchar(50) UNIQUE NOT NULL COMMENT 'ç­‰çº§æ ‡è¯†',
  `discount` decimal(3,2) DEFAULT 1.00 COMMENT 'æŠ˜æ‰£ç‡ï¼ˆ0.95=9.5æŠ˜ï¼‰',
  `price` decimal(10,2) DEFAULT 0 COMMENT 'æœˆè´¹ä»·æ ¼',
  `duration_days` int DEFAULT 30 COMMENT 'æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰',
  `benefits` text COMMENT 'æƒç›Šè¯´æ˜ï¼ˆJSONï¼‰',
  `sort` int DEFAULT 0 COMMENT 'æ’åº',
  `status` tinyint(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼ˆ1=å¯ç”¨ï¼Œ0=ç¦ç”¨ï¼‰',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_slug (slug),
  INDEX idx_status (status)
);

-- åˆå§‹æ•°æ®
INSERT INTO member_levels (name, slug, discount, price, duration_days, benefits, sort) VALUES
('æ™®é€šä¼šå‘˜', 'normal', 1.00, 0, 0, '{"features": ["æ­£å¸¸è´­ä¹°"]}', 1),
('VIPä¼šå‘˜', 'vip', 0.95, 29, 30, '{"features": ["9.5æŠ˜ä¼˜æƒ ", "ä¸“å±å®¢æœ", "ä¼˜å…ˆå‘è´§"]}', 2),
('SVIPä¼šå‘˜', 'svip', 0.90, 99, 30, '{"features": ["9æŠ˜ä¼˜æƒ ", "ä¸“å±å®¢æœ", "ä¼˜å…ˆå‘è´§", "å…è¿è´¹", "ç”Ÿæ—¥ç¤¼åŒ…"]}', 3);
```

#### 2. ä¼šå‘˜è¡¨ï¼ˆmembersï¼‰
```sql
CREATE TABLE `members` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `email` varchar(100) UNIQUE NOT NULL COMMENT 'ä¼šå‘˜é‚®ç®±',
  `level_id` bigint NOT NULL COMMENT 'ä¼šå‘˜ç­‰çº§ID',
  `expire_at` timestamp NULL COMMENT 'åˆ°æœŸæ—¶é—´ï¼ˆNULL=æ°¸ä¹…ï¼‰',
  `total_spent` decimal(10,2) DEFAULT 0 COMMENT 'ç´¯è®¡æ¶ˆè´¹',
  `total_orders` int DEFAULT 0 COMMENT 'è®¢å•æ•°é‡',
  `status` tinyint(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼ˆ1=æ­£å¸¸ï¼Œ0=ç¦ç”¨ï¼‰',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_email (email),
  INDEX idx_level_id (level_id),
  INDEX idx_expire_at (expire_at),
  FOREIGN KEY (level_id) REFERENCES member_levels(id)
);
```

#### 3. ä¼šå‘˜è®¢å•è¡¨ï¼ˆmember_ordersï¼‰
```sql
CREATE TABLE `member_orders` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `member_id` bigint NOT NULL COMMENT 'ä¼šå‘˜ID',
  `level_id` bigint NOT NULL COMMENT 'è´­ä¹°çš„ç­‰çº§ID',
  `order_no` varchar(50) UNIQUE NOT NULL COMMENT 'è®¢å•å·',
  `amount` decimal(10,2) NOT NULL COMMENT 'æ”¯ä»˜é‡‘é¢',
  `duration_days` int NOT NULL COMMENT 'è´­ä¹°æ—¶é•¿ï¼ˆå¤©ï¼‰',
  `pay_method` varchar(50) COMMENT 'æ”¯ä»˜æ–¹å¼',
  `status` tinyint(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼ˆ1=å¾…æ”¯ä»˜ï¼Œ2=å·²æ”¯ä»˜ï¼Œ3=å·²å–æ¶ˆï¼‰',
  `paid_at` timestamp NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `created_at` timestamp,
  `updated_at` timestamp,
  INDEX idx_member_id (member_id),
  INDEX idx_order_no (order_no),
  INDEX idx_status (status),
  FOREIGN KEY (member_id) REFERENCES members(id)
);
```

### ç›®å½•ç»“æ„

```
public/plugins/member-system/
â”œâ”€â”€ plugin.json                 # æ’ä»¶é…ç½®
â”œâ”€â”€ install.php                 # å®‰è£…è„šæœ¬
â”œâ”€â”€ uninstall.php              # å¸è½½è„šæœ¬
â”œâ”€â”€ routes.php                 # è·¯ç”±å®šä¹‰
â”œâ”€â”€ README.md                  # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ MemberController.php   # å‰å°ä¼šå‘˜æ§åˆ¶å™¨
â”‚   â””â”€â”€ AdminMemberController.php  # åå°ç®¡ç†æ§åˆ¶å™¨
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ MemberLevel.php        # ä¼šå‘˜ç­‰çº§æ¨¡å‹
â”‚   â”œâ”€â”€ Member.php             # ä¼šå‘˜æ¨¡å‹
â”‚   â””â”€â”€ MemberOrder.php        # ä¼šå‘˜è®¢å•æ¨¡å‹
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ MemberService.php      # ä¼šå‘˜ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ Middleware/
â”‚   â””â”€â”€ CheckMemberLevel.php   # ä¼šå‘˜ç­‰çº§æ£€æŸ¥ä¸­é—´ä»¶
â””â”€â”€ views/
    â”œâ”€â”€ member/
    â”‚   â”œâ”€â”€ index.blade.php    # ä¼šå‘˜ä¸­å¿ƒ
    â”‚   â”œâ”€â”€ upgrade.blade.php  # å‡çº§ä¼šå‘˜
    â”‚   â””â”€â”€ orders.blade.php   # ä¼šå‘˜è®¢å•
    â””â”€â”€ admin/
        â”œâ”€â”€ members.blade.php  # ä¼šå‘˜åˆ—è¡¨
        â”œâ”€â”€ levels.blade.php   # ç­‰çº§ç®¡ç†
        â””â”€â”€ orders.blade.php   # è®¢å•ç®¡ç†
```

### æ ¸å¿ƒä»£ç è®¾è®¡

#### 1. plugin.json
```json
{
  "name": "ä¼šå‘˜ç³»ç»Ÿ",
  "slug": "member-system",
  "version": "1.0.0",
  "description": "ä¸ºç‹¬è§’å¡æ•°æ·»åŠ ä¼šå‘˜ç­‰çº§å’ŒæŠ˜æ‰£åŠŸèƒ½",
  "author": "ç‹¬è§’å¡æ•°å›¢é˜Ÿ",
  "requires": "1.0.0",
  "type": "feature",
  "icon": "vip",
  "is_free": false,
  "price": 299,
  "settings": {
    "enable_auto_upgrade": {
      "label": "è‡ªåŠ¨å‡çº§",
      "type": "switch",
      "default": true,
      "description": "æ¶ˆè´¹è¾¾æ ‡è‡ªåŠ¨å‡çº§ä¼šå‘˜ç­‰çº§"
    },
    "expire_remind_days": {
      "label": "åˆ°æœŸæé†’å¤©æ•°",
      "type": "number",
      "default": 7,
      "description": "ä¼šå‘˜åˆ°æœŸå‰Nå¤©å‘é€æé†’é‚®ä»¶"
    }
  }
}
```

#### 2. å®‰è£…è„šæœ¬ï¼ˆinstall.phpï¼‰
```php
<?php
return function() {
    try {
        // 1. åˆ›å»ºä¼šå‘˜ç­‰çº§è¡¨
        Schema::create('member_levels', function (Blueprint $table) {
            // ... è¡¨ç»“æ„
        });
        
        // 2. åˆ›å»ºä¼šå‘˜è¡¨
        Schema::create('members', function (Blueprint $table) {
            // ... è¡¨ç»“æ„
        });
        
        // 3. åˆ›å»ºä¼šå‘˜è®¢å•è¡¨
        Schema::create('member_orders', function (Blueprint $table) {
            // ... è¡¨ç»“æ„
        });
        
        // 4. æ’å…¥é»˜è®¤ä¼šå‘˜ç­‰çº§
        DB::table('member_levels')->insert([...]);
        
        // 5. æ·»åŠ åå°èœå•
        DB::table('admin_menu')->insert([
            'title' => 'ä¼šå‘˜ç®¡ç†',
            'icon' => 'fa-users',
            'uri' => 'members',
            'parent_id' => 0,
        ]);
        
        return [
            'success' => true,
            'message' => 'ä¼šå‘˜ç³»ç»Ÿå®‰è£…æˆåŠŸï¼'
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'message' => 'å®‰è£…å¤±è´¥ï¼š' . $e->getMessage()
        ];
    }
};
```

#### 3. ä¼šå‘˜æœåŠ¡ï¼ˆMemberService.phpï¼‰
```php
<?php
namespace Plugins\MemberSystem\Services;

class MemberService
{
    // è·å–ä¼šå‘˜ä¿¡æ¯ï¼ˆé€šè¿‡é‚®ç®±ï¼‰
    public function getMemberByEmail($email) { }
    
    // åˆ›å»ºä¼šå‘˜
    public function createMember($email, $levelId) { }
    
    // å‡çº§ä¼šå‘˜
    public function upgradeMember($memberId, $levelId, $durationDays) { }
    
    // ç»­è´¹ä¼šå‘˜
    public function renewMember($memberId, $durationDays) { }
    
    // æ£€æŸ¥ä¼šå‘˜æ˜¯å¦è¿‡æœŸ
    public function isExpired($member) { }
    
    // è·å–ä¼šå‘˜æŠ˜æ‰£
    public function getDiscount($email) { }
    
    // åº”ç”¨ä¼šå‘˜æŠ˜æ‰£åˆ°è®¢å•
    public function applyDiscount($order, $member) { }
    
    // åˆ›å»ºä¼šå‘˜è®¢å•
    public function createMemberOrder($memberId, $levelId, $durationDays) { }
    
    // å¤„ç†ä¼šå‘˜è®¢å•æ”¯ä»˜æˆåŠŸ
    public function handlePaymentSuccess($orderNo) { }
}
```

#### 4. å‰å°è·¯ç”±ï¼ˆroutes.phpï¼‰
```php
<?php
use Illuminate\Support\Facades\Route;

// ä¼šå‘˜ä¸­å¿ƒ
Route::get('/member', 'MemberController@index')->name('member.index');

// å‡çº§ä¼šå‘˜
Route::get('/member/upgrade', 'MemberController@upgrade')->name('member.upgrade');
Route::post('/member/upgrade', 'MemberController@doUpgrade')->name('member.doUpgrade');

// ä¼šå‘˜è®¢å•
Route::get('/member/orders', 'MemberController@orders')->name('member.orders');

// æ”¯ä»˜å›è°ƒ
Route::post('/member/payment/notify', 'MemberController@paymentNotify')->name('member.payment.notify');
```

### é›†æˆç‚¹

#### 1. è®¢å•åˆ›å»ºæ—¶åº”ç”¨æŠ˜æ‰£
```php
// åœ¨ app/Service/OrderService.php ä¸­
// åˆ›å»ºè®¢å•å‰æ£€æŸ¥ä¼šå‘˜ç­‰çº§å¹¶åº”ç”¨æŠ˜æ‰£

$member = app(MemberService::class)->getMemberByEmail($email);
if ($member && !$member->isExpired()) {
    $discount = $member->level->discount;
    $actualPrice = $originalPrice * $discount;
}
```

#### 2. å‰å°æ˜¾ç¤ºä¼šå‘˜æ ‡è¯†
```php
// åœ¨å•†å“è¯¦æƒ…é¡µæ˜¾ç¤ºä¼šå‘˜ä»·æ ¼
@if(auth()->check() && auth()->user()->member)
    <div class="member-price">
        ä¼šå‘˜ä»·ï¼šÂ¥{{ $goods->price * auth()->user()->member->level->discount }}
    </div>
@endif
```

#### 3. åå°ä¼šå‘˜ç®¡ç†èœå•
```php
// å®‰è£…æ—¶è‡ªåŠ¨æ·»åŠ åˆ° admin_menu è¡¨
ä¼šå‘˜ç®¡ç†
â”œâ”€â”€ ä¼šå‘˜åˆ—è¡¨
â”œâ”€â”€ ä¼šå‘˜ç­‰çº§
â””â”€â”€ ä¼šå‘˜è®¢å•
```

### å¼€å‘è®¡åˆ’

#### é˜¶æ®µä¸€ï¼šæ•°æ®åº“å’Œæ¨¡å‹ï¼ˆ0.5å¤©ï¼‰
- [x] è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„
- [ ] åˆ›å»ºè¿ç§»æ–‡ä»¶
- [ ] åˆ›å»ºæ¨¡å‹ï¼ˆMemberLevel, Member, MemberOrderï¼‰
- [ ] å®šä¹‰æ¨¡å‹å…³ç³»

#### é˜¶æ®µäºŒï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆ1å¤©ï¼‰
- [ ] MemberServiceï¼ˆä¼šå‘˜ä¸šåŠ¡é€»è¾‘ï¼‰
- [ ] ä¼šå‘˜åˆ›å»ºå’Œå‡çº§
- [ ] æŠ˜æ‰£è®¡ç®—
- [ ] è®¢å•å¤„ç†

#### é˜¶æ®µä¸‰ï¼šå‰å°åŠŸèƒ½ï¼ˆ1å¤©ï¼‰
- [ ] ä¼šå‘˜ä¸­å¿ƒé¡µé¢
- [ ] å‡çº§ä¼šå‘˜é¡µé¢
- [ ] ä¼šå‘˜è®¢å•åˆ—è¡¨
- [ ] æ”¯ä»˜é›†æˆ

#### é˜¶æ®µå››ï¼šåå°ç®¡ç†ï¼ˆ1å¤©ï¼‰
- [ ] ä¼šå‘˜åˆ—è¡¨ï¼ˆCRUDï¼‰
- [ ] ä¼šå‘˜ç­‰çº§ç®¡ç†
- [ ] ä¼šå‘˜è®¢å•ç®¡ç†
- [ ] ç»Ÿè®¡æŠ¥è¡¨

#### é˜¶æ®µäº”ï¼šé›†æˆå’Œæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰
- [ ] é›†æˆåˆ°è®¢å•ç³»ç»Ÿï¼ˆåº”ç”¨æŠ˜æ‰£ï¼‰
- [ ] é›†æˆåˆ°å•†å“é¡µé¢ï¼ˆæ˜¾ç¤ºä¼šå‘˜ä»·ï¼‰
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

#### é˜¶æ®µå…­ï¼šæ‰“åŒ…å’Œéƒ¨ç½²ï¼ˆ0.5å¤©ï¼‰
- [ ] ç¼–å†™ README.md
- [ ] æ‰“åŒ…æ’ä»¶ zip
- [ ] ä¸Šä¼ åˆ°æˆæƒç³»ç»Ÿ
- [ ] é…ç½®ä¸‹è½½åœ°å€
- [ ] æµ‹è¯•è´­ä¹°å’Œå®‰è£…æµç¨‹

**æ€»é¢„è®¡æ—¶é—´**ï¼š4-5å¤©

### æŠ€æœ¯è¦ç‚¹

#### 1. ä¼šå‘˜è¯†åˆ«
```php
// é€šè¿‡é‚®ç®±è¯†åˆ«ä¼šå‘˜ï¼ˆç‹¬è§’å¡æ•°æ²¡æœ‰ç”¨æˆ·ç³»ç»Ÿï¼‰
// ä¸‹å•æ—¶è¾“å…¥çš„é‚®ç®±ä½œä¸ºä¼šå‘˜æ ‡è¯†
$member = Member::where('email', $order->email)->first();
```

#### 2. æŠ˜æ‰£åº”ç”¨
```php
// åœ¨è®¢å•åˆ›å»ºæ—¶è‡ªåŠ¨åº”ç”¨ä¼šå‘˜æŠ˜æ‰£
if ($member && !$member->isExpired()) {
    $order->actual_price = $order->actual_price * $member->level->discount;
    $order->member_discount = $member->level->discount;
}
```

#### 3. ä¼šå‘˜åˆ°æœŸå¤„ç†
```php
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ£€æŸ¥ä¼šå‘˜åˆ°æœŸ
// å‘é€åˆ°æœŸæé†’é‚®ä»¶
// è‡ªåŠ¨é™çº§åˆ°æ™®é€šä¼šå‘˜
```

#### 4. æ”¯ä»˜é›†æˆ
```php
// å¤ç”¨ç‹¬è§’å¡æ•°ç°æœ‰çš„æ”¯ä»˜ç³»ç»Ÿ
// ä¼šå‘˜è®¢å•ä¹Ÿèµ° orders è¡¨
// ä½† type æ ‡è®°ä¸º 'member_order'
```

### æµ‹è¯•æ¸…å•

#### åŠŸèƒ½æµ‹è¯•
- [ ] ä¼šå‘˜æ³¨å†Œï¼ˆé¦–æ¬¡ä¸‹å•è‡ªåŠ¨åˆ›å»ºï¼‰
- [ ] ä¼šå‘˜å‡çº§ï¼ˆè´­ä¹°VIP/SVIPï¼‰
- [ ] ä¼šå‘˜ç»­è´¹
- [ ] æŠ˜æ‰£åº”ç”¨ï¼ˆä¸‹å•æ—¶è‡ªåŠ¨æ‰“æŠ˜ï¼‰
- [ ] ä¼šå‘˜åˆ°æœŸï¼ˆè‡ªåŠ¨é™çº§ï¼‰
- [ ] åå°ç®¡ç†ï¼ˆCRUDï¼‰

#### è¾¹ç•Œæµ‹è¯•
- [ ] ä¼šå‘˜å·²è¿‡æœŸæ—¶ä¸‹å•ï¼ˆä¸åº”ç”¨æŠ˜æ‰£ï¼‰
- [ ] éä¼šå‘˜ä¸‹å•ï¼ˆæ­£å¸¸ä»·æ ¼ï¼‰
- [ ] ä¼šå‘˜è®¢å•æ”¯ä»˜å¤±è´¥ï¼ˆä¸å¼€é€šä¼šå‘˜ï¼‰
- [ ] é‡å¤è´­ä¹°ä¼šå‘˜ï¼ˆç´¯åŠ æ—¶é•¿ï¼‰

#### æ€§èƒ½æµ‹è¯•
- [ ] å¤§é‡ä¼šå‘˜æ•°æ®æŸ¥è¯¢
- [ ] æŠ˜æ‰£è®¡ç®—æ€§èƒ½
- [ ] å¹¶å‘è´­ä¹°ä¼šå‘˜

### æ³¨æ„äº‹é¡¹

1. **å…¼å®¹æ€§**ï¼šä¸ä¿®æ”¹ç‹¬è§’å¡æ•°æ ¸å¿ƒä»£ç ï¼Œé€šè¿‡äº‹ä»¶å’Œé’©å­é›†æˆ
2. **æ•°æ®å®‰å…¨**ï¼šä¼šå‘˜æ•°æ®åŠ å¯†å­˜å‚¨ï¼Œé˜²æ­¢æ³„éœ²
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼šå‘˜ä¿¡æ¯ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
4. **ç”¨æˆ·ä½“éªŒ**ï¼šä¼šå‘˜ä»·æ ¼æ˜æ˜¾æ ‡è¯†ï¼Œè´­ä¹°æµç¨‹ç®€å•
5. **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™ç§¯åˆ†ç³»ç»Ÿã€æ¨èå¥–åŠ±ç­‰æ‰©å±•æ¥å£

---

## ğŸ“ ä¸‹æ¬¡ä¼šè¯å¾…åŠäº‹é¡¹

### 1. å¼€å§‹å¼€å‘ä¼šå‘˜ç³»ç»Ÿæ’ä»¶
- [ ] åˆ›å»ºæ’ä»¶ç›®å½•ç»“æ„
- [ ] ç¼–å†™ plugin.json
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶
- [ ] åˆ›å»ºæ¨¡å‹æ–‡ä»¶

### 2. æµ‹è¯•æ’ä»¶å®‰è£…åŠŸèƒ½
- [ ] å‡†å¤‡æµ‹è¯•æ’ä»¶ zip æ–‡ä»¶
- [ ] åœ¨æˆæƒç³»ç»Ÿä¸­é…ç½®ä¸‹è½½åœ°å€
- [ ] æµ‹è¯•æ¿€æ´»æµç¨‹ï¼ˆè¾“å…¥æˆæƒç  â†’ éªŒè¯ â†’ ä¸‹è½½ â†’ å®‰è£…ï¼‰
- [ ] éªŒè¯å®‰è£…ç»“æœï¼ˆæ–‡ä»¶ã€æ•°æ®åº“è®°å½•ï¼‰

### 3. å®Œå–„åŠŸèƒ½
- [ ] æµ‹è¯•å…è´¹æ’ä»¶å®‰è£…
- [ ] æµ‹è¯•ä»˜è´¹æ’ä»¶è´­ä¹° â†’ æ¿€æ´» â†’ å®‰è£…å®Œæ•´æµç¨‹
- [ ] æµ‹è¯•æ’ä»¶å¯ç”¨/ç¦ç”¨
- [ ] æµ‹è¯•æ’ä»¶å¸è½½

### 4. å®‰å…¨åŠ å›º
- [ ] åŠ å¯†æ ¸å¿ƒæ–‡ä»¶ï¼ˆPluginMarketGuardã€PluginLicenseServiceï¼‰
- [ ] æµ‹è¯•é˜²ç¯¡æ”¹æœºåˆ¶
- [ ] éªŒè¯åŸŸåç»‘å®š

## âœ… æœ¬æ¬¡ä¼šè¯å®ŒæˆåŠŸèƒ½

### 1. æƒé™æ§åˆ¶ç³»ç»Ÿ âœ…
**é—®é¢˜**ï¼šä¸€ä¸ªæ¿€æ´»ç å¯ä»¥æ¿€æ´»æ‰€æœ‰æ’ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¿€æ´»æ—¶ä¼ é€’æ’ä»¶çš„ `unique_code`
- æˆæƒç³»ç»ŸéªŒè¯æˆæƒç çš„ `features` å­—æ®µ
- ä¸åŒ¹é…æ—¶è¿”å› 403 é”™è¯¯

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `app/Service/PluginLicenseService.php` - æ¿€æ´»æ—¶ä¼ é€’æ’ä»¶åç§°
- `app/Admin/Controllers/PluginController.php` - éªŒè¯æ’ä»¶æƒé™
- `ruanjianshouquan/app_new/api/licenses.py` - æ¿€æ´»æ¥å£å¢åŠ æƒé™éªŒè¯
- `ruanjianshouquan/app_new/api/public.py` - ç”Ÿæˆæˆæƒæ—¶ä½¿ç”¨ unique_code

**æµ‹è¯•ç»“æœ**ï¼š
- âœ… ç”¨æˆæƒç æ¿€æ´»æœªè´­ä¹°çš„æ’ä»¶ â†’ å¤±è´¥ï¼ˆ403ï¼‰
- âœ… ç”¨æˆæƒç æ¿€æ´»å·²è´­ä¹°çš„æ’ä»¶ â†’ æˆåŠŸ
- âœ… å¢è´­åç”¨åŒä¸€æˆæƒç æ¿€æ´»æ–°æ’ä»¶ â†’ æˆåŠŸ
- âœ… é”™è¯¯æç¤ºæ¸…æ™°å‹å¥½

### 2. æ’ä»¶åŒæ­¥ä¼˜åŒ– âœ…
**é—®é¢˜**ï¼šæˆæƒç³»ç»Ÿåˆ é™¤åŠŸèƒ½åï¼Œç‹¬è§’å¡æ•°ä»æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åŒæ­¥æ—¶è®°å½•æ‰€æœ‰æ¿€æ´»çš„æ’ä»¶
- åˆ é™¤æˆæƒç³»ç»Ÿä¸­ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶çš„æ’ä»¶
- ä¿æŠ¤å·²å®‰è£…çš„æ’ä»¶ä¸è¢«åˆ é™¤

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `app/Admin/Controllers/PluginController.php` - sync() æ–¹æ³•

**æµ‹è¯•ç»“æœ**ï¼š
- âœ… åŒæ­¥åè‡ªåŠ¨æ¸…ç†å·²ä¸‹æ¶çš„æ’ä»¶
- âœ… å·²å®‰è£…çš„æ’ä»¶ä¸ä¼šè¢«åˆ é™¤
- âœ… æç¤ºä¿¡æ¯æ¸…æ™°ï¼ˆåŒæ­¥Xä¸ªï¼Œæ¸…ç†Xä¸ªï¼‰

### 3. é”™è¯¯æç¤ºä¼˜åŒ– âœ…
**é—®é¢˜**ï¼šæƒé™ä¸è¶³æ—¶æ˜¾ç¤º"ç½‘ç»œè¯·æ±‚å¤±è´¥ 400"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- Guzzle ä¸æŠ›å‡º HTTP é”™è¯¯å¼‚å¸¸ï¼ˆ`http_errors => false`ï¼‰
- æ­£ç¡®è§£ææˆæƒç³»ç»Ÿçš„é”™è¯¯ä¿¡æ¯
- ç›´æ¥è¿”å›æˆæƒç³»ç»Ÿçš„é”™è¯¯æç¤º

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `app/Service/PluginLicenseService.php` - activateLicense() æ–¹æ³•
- `app/Admin/Controllers/PluginController.php` - doActivate() æ–¹æ³•

**æµ‹è¯•ç»“æœ**ï¼š
- âœ… æƒé™ä¸è¶³æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- âœ… æ˜¾ç¤ºå½“å‰æˆæƒåŒ…å«çš„åŠŸèƒ½
- âœ… æç¤ºéœ€è¦è´­ä¹°çš„æ’ä»¶

## ğŸ¯ å…³é”®ä»£ç ä½ç½®

### åŒæ­¥æ’ä»¶åˆ—è¡¨
- æ–‡ä»¶ï¼š`app/Admin/Controllers/PluginController.php`
- æ–¹æ³•ï¼š`sync()`
- å…³é”®é€»è¾‘ï¼šä½¿ç”¨ `unique_code` ä½œä¸º slugï¼ŒåŒæ­¥æ‰€æœ‰å­—æ®µ

### æ¿€æ´»æ’ä»¶
- æ–‡ä»¶ï¼š`app/Admin/Controllers/PluginController.php`
- æ–¹æ³•ï¼š`doActivate()`
- å…³é”®é€»è¾‘ï¼šéªŒè¯æˆæƒç  â†’ ç»‘å®šåŸŸå â†’ ä¸‹è½½å®‰è£…

### å®‰è£…æœåŠ¡
- æ–‡ä»¶ï¼š`app/Service/PluginInstallService.php`
- æ–¹æ³•ï¼š`install()`
- å…³é”®é€»è¾‘ï¼šä¸‹è½½ zip â†’ è§£å‹ â†’ è®°å½•æ•°æ®åº“

### æˆæƒæœåŠ¡
- æ–‡ä»¶ï¼š`app/Service/PluginLicenseService.php`
- æ–¹æ³•ï¼š`activateLicense()`
- å…³é”®é€»è¾‘ï¼šè°ƒç”¨æˆæƒç³»ç»Ÿ API éªŒè¯æˆæƒç 

## ğŸ‰ å·²å®ŒæˆåŠŸèƒ½

### åå°è´­ä¹°æµç¨‹ âœ…
1. åå°æ’ä»¶åˆ—è¡¨ï¼ˆ/admin/pluginsï¼‰
2. ç‚¹å‡»"è´­ä¹°"æŒ‰é’® â†’ è·³è½¬åˆ°è´­ä¹°é¡µé¢
3. å¡«å†™é‚®ç®±ã€é€‰æ‹©å¸ç§ï¼ˆUSDT/TRXï¼‰
4. åˆ›å»ºè®¢å• â†’ æ˜¾ç¤ºäºŒç»´ç å’Œæ”¶æ¬¾åœ°å€
5. è‡ªåŠ¨è½®è¯¢è®¢å•çŠ¶æ€ï¼ˆæ¯10ç§’ï¼‰
6. æ”¯ä»˜æˆåŠŸ â†’ æ˜¾ç¤ºæˆæƒç  + é‚®ä»¶é€šçŸ¥
7. å¤åˆ¶æˆæƒç  â†’ è¿”å›æ’ä»¶åˆ—è¡¨

### æŠ€æœ¯å®ç° âœ…
- åå°è´­ä¹°é¡µé¢æœ‰æƒé™ä¿æŠ¤ï¼ˆéœ€è¦ç™»å½•ï¼‰
- ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç 
- æ”¶æ¬¾åœ°å€å¸¦å¤åˆ¶æŒ‰é’®
- è‡ªåŠ¨è½®è¯¢ + æ‰‹åŠ¨åˆ·æ–°
- å‰å°é¡µé¢å·²å…¨éƒ¨åˆ é™¤
- APIæ¥å£ä¿ç•™ä¾›åå°è°ƒç”¨

### æ¶æ„ä¼˜åŠ¿ âœ…
- æƒé™ä¿æŠ¤ï¼šåªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è´­ä¹°
- ç®€åŒ–æ¶æ„ï¼šä¸éœ€è¦ç»´æŠ¤å‰å°é¡µé¢
- å®‰å…¨æ€§é«˜ï¼šå‰å°ä¸æš´éœ²è´­ä¹°å…¥å£
- ä»£ç ç²¾ç®€ï¼šå‡å°‘ç»´æŠ¤æˆæœ¬
